name: ğŸ¤– Integrated AI Currency Analysis - 24/7 Cron

on:
  schedule:
    # çµ±åˆAIç›¸é–¢åˆ†æ (2æ™‚é–“é–“éš”ã€æ‹¡å¼µå¸‚å ´æ™‚é–“ 8-2)
    - cron: '0 8,10,12,14,16,18,20,22,0,2 * * 1-5'  # å¹³æ—¥10å›å®Ÿè¡Œ
    # å€‹åˆ¥ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ (4æ™‚é–“é–“éš”)  
    - cron: '0 8,12,16,20,0 * * 1-5'  # å¹³æ—¥5å›å®Ÿè¡Œ
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

env:
  # Pythonè¨­å®š
  PYTHON_VERSION: '3.11'
  
jobs:
  integrated-analysis:
    name: ğŸ¯ çµ±åˆAIç›¸é–¢åˆ†æ
    runs-on: ubuntu-latest
    # environment: production  # ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆRepository Secretsä½¿ç”¨ï¼‰
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install System Dependencies (TA-Lib)
      run: |
        # TA-Libã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUbuntu 24.04å¯¾å¿œï¼‰
        sudo apt-get update
        sudo apt-get install -y build-essential wget
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make
        sudo make install
        cd ..
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        
    - name: ğŸ”‘ Setup Environment Variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "YAHOO_FINANCE_API_KEY=${{ secrets.YAHOO_FINANCE_API_KEY }}" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        
    - name: ğŸ” Debug Environment Variables
      run: |
        echo "ğŸ” ç’°å¢ƒå¤‰æ•°ç¢ºèª:"
        echo "OpenAI Key exists: $(if [ -n "$OPENAI_API_KEY" ]; then echo 'YES'; else echo 'NO'; fi)"
        echo "Discord URL exists: $(if [ -n "$DISCORD_WEBHOOK_URL" ]; then echo 'YES'; else echo 'NO'; fi)"
        echo "Discord URL format: $(echo $DISCORD_WEBHOOK_URL | sed 's/webhooks\/[0-9]*\/[^\/]*/webhooks\/***\/***/')"
        echo "PYTHONPATH: $PYTHONPATH"
        
    - name: ğŸ“ Create Logs Directory
      run: mkdir -p logs
      
    - name: ğŸ¤– Run Integrated AI Analysis
      run: |
        echo "ğŸš€ çµ±åˆAIç›¸é–¢åˆ†æå®Ÿè¡Œé–‹å§‹ $(date)"
        timeout 180 python scripts/cron/integrated_ai_discord.py || echo "Timeout or error occurred"
        echo "âœ… çµ±åˆAIç›¸é–¢åˆ†æå®Œäº† $(date)"
        
    - name: ğŸ“Š Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integrated-analysis-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7

  technical-analysis:
    name: ğŸ“ˆ å€‹åˆ¥ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ
    runs-on: ubuntu-latest
    # environment: production  # ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆRepository Secretsä½¿ç”¨ï¼‰
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install System Dependencies (TA-Lib)
      run: |
        # TA-Libã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUbuntu 24.04å¯¾å¿œï¼‰
        sudo apt-get update
        sudo apt-get install -y build-essential wget
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make
        sudo make install
        cd ..
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        
    - name: ğŸ”‘ Setup Environment Variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "YAHOO_FINANCE_API_KEY=${{ secrets.YAHOO_FINANCE_API_KEY }}" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        
    - name: ğŸ“ Create Logs Directory
      run: mkdir -p logs
      
    - name: ğŸ“Š Run Technical Analysis
      run: |
        echo "ğŸ“ˆ å€‹åˆ¥ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æå®Ÿè¡Œé–‹å§‹ $(date)"
        timeout 120 python scripts/cron/real_ai_discord_v2.py USD/JPY || echo "Timeout or error occurred"
        echo "âœ… å€‹åˆ¥ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æå®Œäº† $(date)"
        
    - name: ğŸ“Š Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: technical-analysis-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7

  health-check:
    name: ğŸ” System Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿
    # environment: production  # ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆRepository Secretsä½¿ç”¨ï¼‰
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install System Dependencies (TA-Lib)
      run: |
        # TA-Libã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUbuntu 24.04å¯¾å¿œï¼‰
        sudo apt-get update
        sudo apt-get install -y build-essential wget
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make
        sudo make install
        cd ..
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        
    - name: ğŸ”‘ Setup Environment Variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "YAHOO_FINANCE_API_KEY=${{ secrets.YAHOO_FINANCE_API_KEY }}" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        
    - name: ğŸ§ª Test Yahoo Finance Connection
      run: |
        echo "ğŸ§ª Yahoo Financeæ¥ç¶šãƒ†ã‚¹ãƒˆ"
        python tests/api/test_yahoo_finance.py --test connection || echo "Yahoo Finance test failed"
        
    - name: ğŸ§ª Test Technical Indicators
      run: |
        echo "ğŸ§ª ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ãƒ†ã‚¹ãƒˆ"
        python tests/unit/test_technical_indicators.py || echo "Technical indicators test failed"
        
    - name: ğŸ§ª Test Integrated Analysis
      run: |
        echo "ğŸ§ª çµ±åˆåˆ†æãƒ†ã‚¹ãƒˆ"
        python scripts/cron/integrated_ai_discord.py --test || echo "Integrated analysis test failed"
