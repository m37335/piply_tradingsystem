# Exchange Analytics Production Crontab - v2.0
# å‚è€ƒ: crontab-example.txt ã‹ã‚‰ã®æœ€é©åŒ–ç‰ˆ
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/bin:/bin
HOME=/app

# .envèª­ã¿è¾¼ã¿é–¢æ•°å®šç¾©
# ENV_LOAD="export $(cat /app/.env | grep -v '^#' | xargs)"

# ðŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ15åˆ†é–“éš”ã€å¹³æ—¥å¸‚å ´æ™‚é–“ 9:00-17:00ï¼‰
*/15 9-17 * * 1-5 cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 300 python data_scheduler.py --test >> /app/logs/data_cron.log 2>&1

# ðŸ¤– AIåˆ†æžãƒ»Discordé…ä¿¡ï¼ˆ1æ™‚é–“é–“éš”ã€å¹³æ—¥å¸‚å ´æ™‚é–“ï¼‰
0 */1 9-17 * * 1-5 cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 120 python real_ai_discord.py USD/JPY >> /app/logs/ai_cron.log 2>&1

# ðŸ“ˆ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ¯Žæ—¥18:00 JST = 09:00 UTCï¼‰
0 9 * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 60 python -c "
import asyncio
import sys
sys.path.append('/app')
from data_scheduler import DataScheduler
scheduler = DataScheduler()
asyncio.run(scheduler._send_daily_report())
" >> /app/logs/daily_cron.log 2>&1

# ðŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ30åˆ†é–“éš”ï¼‰
*/30 * * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 10 python realtime_monitor.py --interval 1 --no-alerts >> /app/logs/health_cron.log 2>&1

# ðŸŒ APIã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç¢ºèªï¼ˆ10åˆ†é–“éš”ï¼‰
*/10 * * * * timeout 5 curl -s http://localhost:8000/health >> /app/logs/api_health_cron.log 2>&1 || echo "$(date): API down" >> /app/logs/api_health_cron.log

# ðŸ“Š é€±æ¬¡çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ¯Žé€±æœˆæ›œæ—¥ 9:00 JST = 00:00 UTCï¼‰
0 0 * * 1 cd /app && export $(cat .env | grep -v '^#' | xargs) && python -c "
import subprocess
import json
import asyncio
from datetime import datetime
import pytz

async def weekly_report():
    try:
        jst = pytz.timezone('Asia/Tokyo')
        current_time = datetime.now(jst)
        print(f'Weekly stats: {current_time.strftime(\"%Y-%m-%d %H:%M:%S JST\")}')

        # Alpha VantageæŽ¥ç¶šãƒ†ã‚¹ãƒˆ
        result = subprocess.run(['python', 'test_alphavantage.py', '--test', 'connection'],
                              capture_output=True, text=True, cwd='/app')
        av_status = result.returncode == 0

        # ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆ
        env_result = subprocess.run(['python', 'test_env_loading.py'],
                                  capture_output=True, text=True, cwd='/app')
        env_status = env_result.returncode == 0

        print(f'Alpha Vantage test: {av_status}')
        print(f'Environment loading: {env_status}')

        # Discordé€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
        import os
        webhook_url = os.getenv('DISCORD_WEBHOOK_URL')
        if webhook_url:
            import httpx
            message = {
                'content': 'ðŸ“Š **é€±æ¬¡ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆ**',
                'embeds': [{
                    'title': 'ðŸ“ˆ Weekly System Report',
                    'description': 'Exchange Analytics ã‚·ã‚¹ãƒ†ãƒ é€±æ¬¡çµ±è¨ˆ',
                    'color': 0x0099FF,
                    'fields': [
                        {'name': 'â° æ™‚åˆ»', 'value': current_time.strftime('%Y-%m-%d %H:%M:%S JST'), 'inline': True},
                        {'name': 'ðŸ”‘ Alpha Vantage', 'value': 'âœ… æ­£å¸¸' if av_status else 'âŒ ã‚¨ãƒ©ãƒ¼', 'inline': True},
                        {'name': 'ðŸ”§ ç’°å¢ƒå¤‰æ•°', 'value': 'âœ… æ­£å¸¸' if env_status else 'âŒ ã‚¨ãƒ©ãƒ¼', 'inline': True}
                    ],
                    'footer': {'text': 'Weekly System Monitor'}
                }]
            }

            async with httpx.AsyncClient(timeout=5.0) as client:
                await client.post(webhook_url, json=message)
            print('Discordé€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†')

    except Exception as e:
        print(f'Weekly stats error: {e}')

asyncio.run(weekly_report())
" >> /app/logs/weekly_cron.log 2>&1

# ðŸ—‘ï¸ ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¯Žæ—¥2:00 JST = 17:00 UTCï¼‰
0 17 * * * cd /app/logs && find . -name "*.log" -size +10M -exec gzip {} \; && find . -name "*.gz" -mtime +7 -delete >> /app/logs/cleanup.log 2>&1

# ðŸ” ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–ï¼ˆ5åˆ†é–“éš”ï¼‰
*/5 * * * * [ -f /app/logs/data_scheduler.log ] && tail -10 /app/logs/data_scheduler.log | grep -i "error\|failed" && echo "$(date): Errors detected" >> /app/logs/error_alert.log

# ðŸ§ª ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆï¼ˆ10åˆ†é–“éš”ã€ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
*/10 * * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 30 python test_env_loading.py >> /app/logs/env_test_cron.log 2>&1
