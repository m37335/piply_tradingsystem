# Exchange Analytics - æœ¬æ ¼é‹ç”¨ç‰ˆCrontabè¨­å®š
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/bin:/bin
HOME=/app

# ðŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆæ¯Žåˆ†å®Ÿè¡Œï¼‰
* * * * * echo "$(date): Cron is working!" >> /app/logs/cron_test.log

# ðŸ”§ ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆï¼ˆ2åˆ†é–“éš”ï¼‰
*/2 * * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 30 python test_env_loading.py >> /app/logs/env_test_cron.log 2>&1

# ðŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆ3åˆ†é–“éš”ï¼‰
*/3 * * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 60 python data_scheduler.py --test >> /app/logs/scheduler_cron.log 2>&1

# ðŸŒ APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†é–“éš”ï¼‰
*/5 * * * * timeout 5 curl -s http://localhost:8000/health >> /app/logs/api_health_cron.log 2>&1 || echo "$(date): API check failed" >> /app/logs/api_health_cron.log

# ðŸ¤– AIåˆ†æžãƒ†ã‚¹ãƒˆï¼ˆ10åˆ†é–“éš”ã€.envå¯¾å¿œï¼‰
*/10 * * * * cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 60 python -c "
import asyncio
import os
from datetime import datetime
import pytz

async def test_ai_analysis():
    try:
        # ç’°å¢ƒå¤‰æ•°ç¢ºèª
        openai_key = os.getenv('OPENAI_API_KEY', '')
        webhook_url = os.getenv('DISCORD_WEBHOOK_URL', '')

        print(f'{datetime.now(pytz.timezone(\"Asia/Tokyo\")).strftime(\"%Y-%m-%d %H:%M:%S JST\")}: AIåˆ†æžãƒ†ã‚¹ãƒˆ')
        print(f'OpenAI Key: {openai_key[:10]}...' if openai_key else 'OpenAI Key: æœªè¨­å®š')
        print(f'Discord Webhook: è¨­å®šæ¸ˆã¿' if webhook_url else 'Discord Webhook: æœªè¨­å®š')

        if webhook_url:
            import httpx
            message = {
                'content': 'ðŸ¤– **AIåˆ†æžã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ**',
                'embeds': [{
                    'title': 'âœ… Cron AI Test',
                    'description': 'crontabã‹ã‚‰ã®AIåˆ†æžãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
                    'color': 0x00FF00,
                    'fields': [
                        {'name': 'â° æ™‚åˆ»', 'value': datetime.now(pytz.timezone(\"Asia/Tokyo\")).strftime('%H:%M:%S JST'), 'inline': True},
                        {'name': 'ðŸ”§ å®Ÿè¡Œå…ƒ', 'value': 'cron AI test', 'inline': True}
                    ]
                }]
            }

            async with httpx.AsyncClient(timeout=5.0) as client:
                await client.post(webhook_url, json=message)
            print('Discordé€šçŸ¥é€ä¿¡å®Œäº†')

    except Exception as e:
        print(f'ã‚¨ãƒ©ãƒ¼: {str(e)}')

asyncio.run(test_ai_analysis())
" >> /app/logs/ai_test_cron.log 2>&1
