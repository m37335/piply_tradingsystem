# 裁量補助モード自動売買システム 包括技術仕様書 v2.0

**作成日**: 2025年1月4日  
**バージョン**: v2.0  
**対象システム**: モジュール型裁量補助モード自動売買システム  
**目的**: 完全なモジュール型設計によるシステム再構築

---

## 📋 目次

1. [システム概要](#1-システム概要)
2. [アーキテクチャ設計](#2-アーキテクチャ設計)
3. [モジュール設計](#3-モジュール設計)
4. [データベース設計](#4-データベース設計)
5. [API制限対策](#5-api制限対策)
6. [LLM分析システム](#6-llm分析システム)
7. [Docker環境構築](#7-docker環境構築)
8. [Git/GitHubワークフロー](#8-gitgithubワークフロー)
9. [テスト戦略](#9-テスト戦略)
10. [運用・監視](#10-運用監視)
11. [実装計画](#11-実装計画)
12. [付録](#12-付録)

---

## 1. システム概要

### 1.1 目的と範囲

本システムは USD/JPY の M5 足を対象とした「裁量補助モード」トレーディングシステムである。

**基本方針**
- 機械学習による市場分析とシグナル生成
- LLMによる高度な市場解釈とリスク分析
- Discord を通じた提案配信（ENTRY PROPOSAL / OBSERVE）
- 最終的な発注判断は人間が実行
- 自動発注機能は実装しない

**対象市場**
- 通貨ペア: USD/JPY
- 時間足: M5（5分足）
- 取引時間: 24時間（イベント窓除く）

### 1.2 システム責任範囲

| 機能領域 | システム責任 | 人間責任 |
|---------|------|----|
| データ収集 | ✓ | - |
| 特徴量計算 | ✓ | - |
| AI推論 | ✓ | - |
| LLM分析 | ✓ | - |
| リスク評価 | ✓ | - |
| 提案生成 | ✓ | - |
| Discord通知 | ✓ | - |
| 発注判断 | - | ✓ |
| ポジション管理 | - | ✓ |
| 損切り/利確 | - | ✓ |

### 1.3 用語・定義

| 用語 | 定義 |
|---------|---------------------------------|
| **p** | 上昇確率（Isotonic Regression 校正後、0-1） |
| **μ** | 期待リターン（bp単位、手数料控除後） |
| **RR** | リスクリワード比（期待リターン ÷ 想定損失） |
| **ATR%** | ATR14 ÷ close × 100（ボラティリティ指標） |
| **イベント窓** | 経済指標発表前後の取引禁止時間帯 |
| **スティッチ** | 複数データソースの統合・品質管理処理 |
| **分位変換** | 特徴量の分布を正規化する統計処理 |
| **縮小ケリー** | ケリー基準の0.5倍でリスクを抑制した資金管理 |

---

## 2. アーキテクチャ設計

### 2.1 モジュール型アーキテクチャ

```
/app/
├── core/                          # コア機能（共通基盤）
│   ├── config/                    # 統一設定管理
│   ├── logging/                   # 統一ログ管理
│   ├── utils/                     # 共通ユーティリティ
│   ├── interfaces/                # 共通インターフェース
│   └── exceptions/                # 共通例外
│
├── modules/                       # 機能モジュール
│   ├── data_collection/           # データ収集モジュール
│   ├── feature_engineering/       # 特徴量エンジンモジュール
│   ├── ml_inference/              # ML推論モジュール
│   ├── llm_analysis/              # LLM分析モジュール
│   ├── risk_management/           # リスク管理モジュール
│   ├── signal_generation/         # シグナル生成モジュール
│   ├── notification/              # 通知モジュール
│   ├── monitoring/                # 監視モジュール
│   └── data_persistence/          # データ永続化モジュール
│
├── orchestration/                 # オーケストレーション層
├── api/                          # API層
├── cli/                          # CLI層
├── tests/                        # 統合テスト
├── config/                       # 設定ファイル
├── scripts/                      # スクリプト
├── docs/                         # ドキュメント
├── docker/                       # Docker設定
└── requirements/                 # 依存関係
```

### 2.2 データフロー

```
データ収集 → 特徴量計算 → [ML推論 + LLM分析] → 統合分析 → リスク管理 → シグナル生成 → Discord通知 → 人間判断
```

### 2.3 主要コンポーネント

- **DataCollector**: 多元データ収集・統合
- **FeatureEngine**: テクニカル指標計算・正規化
- **MLInference**: LightGBM推論エンジン
- **LLMAnalyzer**: LLM分析エンジン
- **RiskGate**: 多層リスク管理システム
- **SignalGenerator**: 提案シナリオ生成
- **DiscordNotifier**: 通知配信システム
- **AuditLogger**: 監査ログ・トレーサビリティ

---

## 3. モジュール設計

### 3.1 データ収集モジュール

#### 3.1.1 機能概要
- Yahoo Finance API からの価格データ収集
- 複数時間足（M1, M5, M15, H1, H4, D1）の管理
- データ品質管理とスティッチ処理
- API制限対策とレート制限管理

#### 3.1.2 主要クラス
```python
class YahooFinanceCollector:
    """Yahoo Finance データ収集器"""
    
class RateLimiter:
    """レート制限管理クラス"""
    
class IntelligentDataCollector:
    """インテリジェントデータ収集器"""
    
class DatabaseSaver:
    """データベース保存器"""
```

#### 3.1.3 設定例
```yaml
# config/modules/data_collection.yaml
rate_limiting:
  yahoo_finance:
    requests_per_minute: 45
    requests_per_hour: 1200
    requests_per_day: 10000
    burst_limit: 5
    cooldown_seconds: 120

collection_strategy:
  initial_collection:
    batch_size_days: 30
    delay_between_batches: 5
    max_retries: 3
  
  regular_updates:
    market_hours_frequency: 5
    non_market_frequency: 15
    weekend_backfill: true
```

### 3.2 LLM分析モジュール

#### 3.2.1 機能概要
- データベース保存データを基にしたLLM分析
- 市場センチメント分析
- パターン解釈・説明
- リスクシナリオ分析

#### 3.2.2 主要クラス
```python
class DatabaseLLMAnalyzer:
    """データベース連携型LLM分析器"""
    
class LLMDataPreparator:
    """LLM分析用データ準備器"""
    
class LLMClient:
    """LLM API クライアント"""
    
class AnalysisAggregator:
    """分析結果統合器"""
```

#### 3.2.3 分析タイプ
- **market_sentiment**: 市場センチメント分析
- **pattern_interpretation**: パターン解釈
- **risk_scenario**: リスクシナリオ分析

### 3.3 リスク管理モジュール

#### 3.3.1 多層ゲート判定
1. **AI品質ゲート**: p ≥ 0.58 かつ RR ≥ 1.30
2. **市場環境ゲート**: ATR%, スプレッド, 流動性チェック
3. **イベント窓ゲート**: 経済指標発表時間の制御
4. **パフォーマンスゲート**: 連敗・SLA監視
5. **重複提案抑制**: 同方向未決済提案の制御

#### 3.3.2 リスク・リワード設定
- **SL**: 1.2 × ATR14
- **TP**: [0.6, 1.2, 1.8] × ATR14
- **最大保有時間**: 180分
- **推奨サイズ**: 縮小ケリー（0.5倍）、上限 0.6% equity

### 3.4 通知モジュール

#### 3.4.1 Discord通知フォーマット
- **ENTRY PROPOSAL**: 緑色、提案配信
- **OBSERVE**: 黄色、観察推奨
- **日次スレッド**: 06:00 JST作成
- **進行管理**: TP/SL/時間切れの返信

---

## 4. データベース設計

### 4.1 価格データテーブル

```sql
CREATE TABLE price_data (
    id BIGSERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(5) NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    open DECIMAL(10,5) NOT NULL,
    high DECIMAL(10,5) NOT NULL,
    low DECIMAL(10,5) NOT NULL,
    close DECIMAL(10,5) NOT NULL,
    volume BIGINT,
    adjusted_close DECIMAL(10,5),
    dividend_amount DECIMAL(10,5) DEFAULT 0,
    split_coefficient DECIMAL(10,5) DEFAULT 1,
    source VARCHAR(20) DEFAULT 'yahoo_finance',
    data_quality_score DECIMAL(3,2) DEFAULT 1.0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT pk_price_data UNIQUE (symbol, timeframe, timestamp)
);
```

### 4.2 LLM分析結果テーブル

```sql
CREATE TABLE llm_analysis_results (
    id BIGSERIAL PRIMARY KEY,
    analysis_id UUID NOT NULL DEFAULT gen_random_uuid(),
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(5) NOT NULL,
    analysis_timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    analysis_type VARCHAR(50) NOT NULL,
    data_start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    data_end_time TIMESTAMP WITH TIME ZONE NOT NULL,
    data_points_count INTEGER NOT NULL,
    llm_provider VARCHAR(20) NOT NULL,
    llm_model VARCHAR(50) NOT NULL,
    prompt_version VARCHAR(10) NOT NULL,
    analysis_result JSONB NOT NULL,
    confidence_score DECIMAL(3,2),
    processing_time_seconds INTEGER,
    cost_usd DECIMAL(8,4),
    tokens_used INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT pk_llm_analysis UNIQUE (analysis_id)
);
```

### 4.3 シグナルテーブル

```sql
CREATE TABLE signals (
    signal_id UUID PRIMARY KEY,
    pair VARCHAR(10) NOT NULL,
    ts TIMESTAMP NOT NULL,
    tf VARCHAR(5) NOT NULL,
    direction VARCHAR(10),
    probability DECIMAL(6,4),
    expected_return DECIMAL(8,2),
    risk_reward DECIMAL(6,3),
    regime VARCHAR(20),
    entry_price DECIMAL(10,5),
    sl_price DECIMAL(10,5),
    tp1_price DECIMAL(10,5),
    tp2_price DECIMAL(10,5),
    tp3_price DECIMAL(10,5),
    gate_status VARCHAR(20),
    gate_reasons JSONB,
    discord_message_id BIGINT,
    notified_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 5. API制限対策

### 5.1 レート制限管理

#### 5.1.1 制限値設定
```python
@dataclass
class RateLimitConfig:
    requests_per_minute: int = 45
    requests_per_hour: int = 1200
    requests_per_day: int = 10000
    burst_limit: int = 5
    cooldown_seconds: int = 120
```

#### 5.1.2 インテリジェント収集戦略
- 優先度ベースのデータ収集
- 市場時間を考慮したスケジューリング
- バッチ処理による効率化
- 代替データソースの準備

### 5.2 代替データソース戦略

#### 5.2.1 フォールバック順序
1. Yahoo Finance（メイン）
2. Alpha Vantage（代替1）
3. Finnhub（代替2）
4. キャッシュデータ（最終）

#### 5.2.2 コスト管理
- 日次・月次使用量制限
- アラート閾値設定
- 使用量監視・レポート

---

## 6. LLM分析システム

### 6.1 データベース連携型分析

#### 6.1.1 分析データ準備
```python
class LLMDataPreparator:
    async def prepare_analysis_data(
        self, 
        analysis_type: str, 
        symbol: str = 'USDJPY=X'
    ) -> Dict:
        """分析用データの準備"""
```

#### 6.1.2 分析タイプ別設定
```yaml
analysis_windows:
  market_sentiment:
    timeframes: ['M5', 'M15', 'H1']
    lookback_hours: 24
    max_data_points: 1000
  
  pattern_interpretation:
    timeframes: ['M15', 'H1', 'H4']
    lookback_hours: 72
    max_data_points: 500
  
  risk_scenario:
    timeframes: ['H1', 'H4', 'D1']
    lookback_hours: 168
    max_data_points: 200
```

### 6.2 プロンプトエンジン

#### 6.2.1 プロンプトテンプレート
```json
{
  "market_analysis": {
    "system_prompt": "あなたは経験豊富な為替トレーダーです。",
    "user_prompt_template": "以下の市場データを分析してください：\n{data_summary}"
  }
}
```

#### 6.2.2 分析結果の構造化
- センチメントスコア（0-100）
- 信頼度（0-100）
- 主要観察事項
- リスク要因
- 推奨アクション

---

## 7. Docker環境構築

### 7.1 マルチコンテナ構成

```yaml
# docker-compose.yml
version: '3.8'

services:
  trading-system:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    container_name: trading-system-dev
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/trading_system_dev
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15-alpine
    container_name: trading-postgres-dev
    environment:
      - POSTGRES_DB=trading_system_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    container_name: trading-redis-dev
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
```

### 7.2 マルチステージDockerfile

```dockerfile
# docker/Dockerfile
FROM python:3.11-slim as base

WORKDIR /app
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

FROM base as development
COPY requirements/development.txt .
RUN pip install --no-cache-dir -r development.txt
COPY . .
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

FROM base as production
COPY requirements/production.txt .
RUN pip install --no-cache-dir -r production.txt
RUN groupadd -r appuser && useradd -r -g appuser appuser
COPY . .
RUN chown -R appuser:appuser /app
USER appuser
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

### 7.3 開発環境セットアップ

```bash
# セットアップスクリプト
#!/bin/bash
# scripts/setup-dev-environment.sh

echo "🚀 開発環境セットアップ開始"

# 環境変数ファイルの作成
cp .env.example .env

# Dockerイメージのビルド
docker-compose build

# データベースの起動
docker-compose up -d postgres redis

# マイグレーションの実行
docker-compose run --rm trading-system alembic upgrade head

# 全サービスの起動
docker-compose up -d

echo "✅ 開発環境セットアップ完了！"
```

---

## 8. Git/GitHubワークフロー

### 8.1 ブランチ戦略

```bash
# メインブランチ
main                    # 本番環境用（保護）
develop                 # 開発統合用（保護）

# 機能ブランチ
feature/data-collection     # データ収集モジュール
feature/llm-analysis        # LLM分析モジュール
feature/risk-management     # リスク管理モジュール

# リリースブランチ
release/v1.0.0             # リリース準備用

# ホットフィックスブランチ
hotfix/critical-bug-fix    # 緊急修正用
```

### 8.2 CI/CDパイプライン

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements/development.txt
      - name: Code formatting check
        run: black --check modules/ core/ api/ cli/
      - name: Linting
        run: flake8 modules/ core/ api/ cli/

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trading_system_test
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements/development.txt
      - name: Run tests
        run: pytest tests/ -v --cov=modules --cov=core
```

### 8.3 コミットメッセージ規約

```bash
# コミットメッセージ形式
<type>(<scope>): <subject>

<body>

<footer>

# 例
feat(data-collection): add Yahoo Finance rate limiting

Implement comprehensive rate limiting system for Yahoo Finance API
to prevent API quota exhaustion and improve data collection reliability.

- Add RateLimiter class with configurable limits
- Implement exponential backoff for failed requests
- Add monitoring and alerting for rate limit violations

Closes #123
```

---

## 9. テスト戦略

### 9.1 テスト階層構造

```
/app/tests/
├── conftest.py               # pytest設定
├── integration/              # 統合テスト
├── e2e/                      # E2Eテスト
└── fixtures/                 # テストフィクスチャ
```

### 9.2 モジュール別テスト

```python
# modules/llm_analysis/tests/test_unit.py
import pytest
from modules.llm_analysis.core.llm_client import LLMClient

class TestLLMClient:
    @pytest.fixture
    def llm_client(self):
        return LLMClient()
    
    @patch('openai.ChatCompletion.create')
    async def test_openai_request_success(self, mock_create, llm_client):
        mock_create.return_value = {
            'choices': [{'message': {'content': 'Test response'}}]
        }
        
        result = await llm_client.analyze_market_sentiment({
            'price': 150.000,
            'rsi': 65.0,
            'macd': 0.5
        })
        
        assert result['status'] == 'success'
        assert 'content' in result
```

### 9.3 テスト実行コマンド

```bash
# 単体テスト実行
pytest modules/*/tests/test_unit.py -v

# 統合テスト実行
pytest tests/integration/ -v

# E2Eテスト実行
pytest tests/e2e/ -v

# カバレッジ付きテスト
pytest tests/ --cov=modules --cov=core --cov-report=html
```

---

## 10. 運用・監視

### 10.1 SLA定義・監視

```python
SLA_METRICS = {
    'processing_time_m5': {
        'target': 30,        # 30秒以内
        'warning': 45,       # 警告閾値
        'critical': 60       # 緊急閾値
    },
    'data_availability': {
        'target': 99.5,      # 99.5%以上
        'warning': 98.0,
        'critical': 95.0
    },
    'prediction_latency': {
        'target': 5,         # 5秒以内
        'warning': 8,
        'critical': 10
    }
}
```

### 10.2 監視ダッシュボード

- **Prometheus**: メトリクス収集
- **Grafana**: 可視化ダッシュボード
- **アラート**: Discord通知
- **ログ管理**: 構造化ログ

### 10.3 バックアップ・災害復旧

#### 10.3.1 バックアップ戦略
```bash
# 日次差分バックアップ
pg_dump --format=custom --no-owner --no-privileges \
    --exclude-table=audit_log \
    $DB_NAME > $BACKUP_DIR/daily_$(date +%Y%m%d).dump

# 週次フルバックアップ
if [ $(date +%u) -eq 7 ]; then
    pg_dump --format=custom --no-owner --no-privileges \
        $DB_NAME > $BACKUP_DIR/weekly_$(date +%Y%m%d).dump
fi
```

#### 10.3.2 災害復旧目標
- **RTO (Recovery Time Objective)**: 1時間以内
- **RPO (Recovery Point Objective)**: 1時間以内

---

## 11. 実装計画

### 11.1 段階的実装計画

#### Phase 1: 基盤構築（1-2週間）
- [ ] 新しいフォルダ構造の作成
- [ ] コア設定システムの実装
- [ ] 共通インターフェースの定義
- [ ] 基本的なテストフレームワークの構築

#### Phase 2: データ収集モジュール（2-3週間）
- [ ] データ収集モジュールの実装
- [ ] Yahoo Finance API連携
- [ ] データ統合（Stitch処理）の実装
- [ ] API制限対策の実装
- [ ] 単体・統合テストの実装

#### Phase 3: 特徴量エンジンモジュール（2-3週間）
- [ ] 特徴量計算モジュールの実装
- [ ] テクニカル指標計算の移行
- [ ] 正規化・変換処理の実装
- [ ] テストの実装

#### Phase 4: ML推論モジュール（2-3週間）
- [ ] ML推論モジュールの実装
- [ ] LightGBMモデルの移行
- [ ] 確率校正の実装
- [ ] テストの実装

#### Phase 5: LLM分析モジュール（3-4週間）
- [ ] LLM分析モジュールの実装
- [ ] OpenAI、Anthropic連携
- [ ] プロンプトエンジンの実装
- [ ] 分析結果統合の実装
- [ ] テストの実装

#### Phase 6: リスク管理モジュール（2-3週間）
- [ ] リスク管理モジュールの実装
- [ ] 多層ゲート判定の移行
- [ ] ポジションサイジングの実装
- [ ] テストの実装

#### Phase 7: シグナル生成モジュール（2-3週間）
- [ ] シグナル生成モジュールの実装
- [ ] TP/SL計算の実装
- [ ] シナリオ構築の実装
- [ ] テストの実装

#### Phase 8: 通知モジュール（1-2週間）
- [ ] 通知モジュールの実装
- [ ] Discord通知の移行
- [ ] フォーマッターの実装
- [ ] テストの実装

#### Phase 9: 監視モジュール（2-3週間）
- [ ] 監視モジュールの実装
- [ ] SLA監視の実装
- [ ] ヘルスチェックの実装
- [ ] テストの実装

#### Phase 10: データ永続化モジュール（2-3週間）
- [ ] データ永続化モジュールの実装
- [ ] データベースモデルの移行
- [ ] バックアップ管理の実装
- [ ] テストの実装

#### Phase 11: オーケストレーション層（2-3週間）
- [ ] パイプラインエンジンの実装
- [ ] スケジューラーの実装
- [ ] イベントバスの実装
- [ ] 統合テストの実装

#### Phase 12: API・CLI層（1-2週間）
- [ ] API層の実装
- [ ] CLI層の実装
- [ ] 認証・認可の実装
- [ ] テストの実装

#### Phase 13: 統合・最適化（2-3週間）
- [ ] 全モジュールの統合
- [ ] パフォーマンス最適化
- [ ] E2Eテストの実装
- [ ] 本番環境での検証

### 11.2 リスク管理

#### 技術的リスク
- 既存システムとの互換性問題
- パフォーマンス要件（30秒以内）の維持
- データ整合性の確保

#### 対策
- 段階的な移行と並行運用
- 包括的なテストカバレッジ
- ロールバック計画の準備

#### 運用リスク
- システム停止時間の最小化
- データ損失の防止
- 運用チームの教育

#### 対策
- ブルーグリーンデプロイメント
- データバックアップの徹底
- ドキュメント整備とトレーニング

---

## 12. 付録

### 12.1 設定ファイル例

#### 12.1.1 システム設定
```yaml
# config/base.yaml
system:
  timezone: "Asia/Tokyo"
  base_currency: "JPY"
  target_pair: "USD/JPY"
  timeframe: "M5"
  
data_sources:
  yahoo:
    enabled: true
    timeout: 30
    retry_count: 3
  oanda:
    enabled: true
    account_id: "${OANDA_ACCOUNT_ID}"
    access_token: "${OANDA_ACCESS_TOKEN}"
    environment: "practice"

ml_model:
  model_path: "models/lgbm_usdjpy_m5_2024w15.pkl"
  feature_version: "v2.0"
  calibration_enabled: true
  
risk_management:
  probability_threshold: 0.58
  rr_threshold: 1.30
  max_position_risk: 0.006
  kelly_fraction: 0.5
  
discord:
  token: "${DISCORD_TOKEN}"
  guild_id: 123456789
  channel_id: 987654321
```

#### 12.1.2 LLM分析設定
```yaml
# config/modules/llm_analysis.yaml
llm:
  openai:
    model: "gpt-4o"
    max_tokens: 2000
    temperature: 0.3
    timeout: 30
  
  anthropic:
    model: "claude-3-5-sonnet-20241022"
    max_tokens: 2000
    temperature: 0.3
    timeout: 30

analysis:
  market_sentiment:
    enabled: true
    frequency: "M5"
    provider: "openai"
    
  pattern_interpretation:
    enabled: true
    frequency: "M15"
    provider: "anthropic"
    
  risk_scenario:
    enabled: true
    frequency: "H1"
    provider: "openai"

cost_management:
  daily_limit_usd: 50.0
  monthly_limit_usd: 1000.0
  alert_threshold_percent: 80.0
```

### 12.2 環境変数設定

```bash
# .env.example
# 環境設定
ENVIRONMENT=development
DEBUG=true
LOG_LEVEL=INFO

# データベース設定
DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/trading_system_dev
POSTGRES_DB=trading_system_dev
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password

# Redis設定
REDIS_URL=redis://redis:6379/0

# LLM API設定
OPENAI_API_KEY=your_openai_api_key_here
ANTHROPIC_API_KEY=your_anthropic_api_key_here

# Discord設定
DISCORD_WEBHOOK_URL=your_discord_webhook_url_here
DISCORD_TOKEN=your_discord_token_here
```

### 12.3 便利なコマンド

```bash
# 開発環境セットアップ
make setup

# 開発環境起動
make up

# テスト実行
make test

# コードフォーマット
make lint

# データベースマイグレーション
make migrate

# コンテナ内でシェル
make shell

# Jupyter Lab起動
make jupyter

# 監視ダッシュボード起動
make monitoring
```

### 12.4 受け入れ基準（DoD）

#### 機能要件DoD
- [ ] 提案/観察/スキップの判定が仕様通り再現できる
- [ ] Discord出力に必須項目が全て含まれる
- [ ] イベント窓・ATR帯・Spread分位で適切に制御される
- [ ] Stitch判定が閾値通り機能し、監査ログに記録される
- [ ] SLA超過で通知・抑制が発動する

#### 非機能要件DoD
- [ ] データ品質・整合性が保証される
- [ ] 監査ログが適切に記録される
- [ ] パフォーマンス要件（30秒以内）を満たす
- [ ] 監視・アラートが適切に設定される
- [ ] バックアップ・復旧手順が検証される

---

**文書管理情報**

- 文書ID: TRD-SPEC-002
- バージョン: v2.0
- 作成日: 2025-01-04
- 承認者: [システム設計者]
- 次回レビュー予定: 2025-02-04
