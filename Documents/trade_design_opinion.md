# トレード評価・ルール改善システム設計意見書

## 1. 背景と目的
- トレードスタイル：数時間で完結、1日3〜5回程度
- 基本指標：RSI, MACD, SMA, ATR + フィボナッチ
- ルールベースを中心に、LLMは「言語化・日誌・改善提案」に限定
- 目的：
  - シナリオごとにトレード実行を記録
  - 翌日に自動検証・評価
  - ルールベース改善の候補を提示
  → ユーザー評価に依存しない仕組みの構築

## 2. スナップ保存の定義
**スナップ保存＝エントリー/エグジット時点の相場環境記録**
- 保存内容
  - 価格（entry/exit）、直近高安
  - RSI, MACD(line/signal/hist), SMA50/200, ATR
  - フィボナッチ水準（retracement/extension）
  - セッション（東京/ロンドン/NY）、時間足情報
- 目的
  - ルール遵守チェックの根拠を残す
  - LLMによる日誌化・改善提案に利用

## 3. シナリオ管理
### 概念
- **戦略（strategy）**：押し目/ブレイク/逆張り等、汎用ルール
- **シナリオ（scenario）**：当日・時間帯・価格水準を具体化した「作戦カード」
- **トレード（trade）**：実際の約定（0〜多件）

### シナリオのライフサイクル
`planned → armed(監視) → triggered(条件成立) → entered(約定) → exited/canceled/expired`

## 4. ルール遵守判定（Adherence）
- 評価項目（配点例：20点×5 = 100点）
  - SMA200方向一致
  - RSI閾値（例：≤40）
  - MACDクロス＋ゼロライン
  - フィボ押し/戻りゾーン
  - 損切/利確・保有時間の遵守
- 乖離タグ例
  - `early_entry`, `late_entry`, `trend_violation`
  - `rule_conflict_sl`, `over_hold_time`, `news_blackout`

## 5. アノマリー/曜日/セッション組み込み
- セッション：東京/ロンドン/NYを active_window_jst で制御
- 曜日：過去ログから勝率/期待RRを計算、優先度やリスク％を微調整
- アノマリー：主要指標は blackout、金曜NY後半は保有短縮、月末ロンドンFIXはロット縮小

## 6. 目的関数設計
- **ハード制約**：1%/trade, 3%/day, 保有30–240分, blackout厳守, 相関リスク上限
- **合成スコア例**
  Score = Median(R) + PF_cap - DD_pen - Var⁻(R) + Adherence - Cost - Complexity
- 最大化対象：`daily_score_p05`（日次スコア下位5%分位）

## 7. LLMの役割
- **やらない**：シグナル生成、数値最適化
- **やる**：日誌作成、改善提案、ルール修正案のパッチ（数値は提案のみ）

## 8. 実装フロー
1. スナップ保存（entry/exit）
2. ルール照合（adherenceスコア＋乖離タグ）
3. シナリオ評価（日次集計）
4. 目的関数評価（daily_score_p05）
5. LLM日次ジョブ（レポート生成）
6. ルール改善（提案を検証→反映）

## 9. 安全設計の要点
- 数値判定はルールベース
- リスク制約はハード条件
- アノマリー/曜日効果は微調整
- 目的関数は下位分位を最大化
- ルール改訂はローリング検証必須

## 10. 今後の展開
- シナリオ自動生成（高安/フィボ基準）
- 相関リスク管理の強化
- LLMレポートをNotion/Discord配信
- ABテストによるルール改訂
