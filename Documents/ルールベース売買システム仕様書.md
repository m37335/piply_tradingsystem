# ルールベース売買システム仕様書

**作成日**: 2025年1月4日  
**最終更新**: 2025年9月18日  
**バージョン**: v3.0  
**対象モジュール**: llm_analysis（ルールベース売買システムに拡張）  
**目的**: ルールベース中心の売買シナリオ生成・評価・改善システムの完全仕様

---

## 📋 目次

1. [モジュール概要](#1-モジュール概要)
2. [アーキテクチャ設計](#2-アーキテクチャ設計)
3. [機能仕様](#3-機能仕様)
4. [データフロー](#4-データフロー)
5. [API仕様](#5-api仕様)
6. [設定仕様](#6-設定仕様)
7. [実装計画](#7-実装計画)
8. [品質要件](#8-品質要件)

---

## 1. モジュール概要

### 1.1 目的
既存の`llm_analysis`モジュールを拡張し、現在の市場データを基に、ルールベースで売買シナリオを生成し、Yahoo Finance APIでリアルタイム通知を行い、Discord配信で売買タイミングを提供するシステム。LLMは分析を行わず、言語化・日誌・改善提案に限定。OANDAの認証問題を回避し、Yahoo Finance APIを使用してリアルタイムデータを取得します。

### 1.2 主要機能
- **Yahoo Finance API連携**: リアルタイム価格データ取得・売買タイミング通知（認証不要）
- **ルールベース判定**: 数値ベースの厳格な売買条件判定
- **階層的テクニカル分析**: 大局（D1・H4）→戦術（H1）→執行（M5）の3段階分析
- **イベント駆動アーキテクチャ**: データ収集完了時の自動テクニカル分析実行
- **スナップ保存**: エントリー/エグジット時点の相場環境記録
- **ルール遵守判定**: 100点満点でのトレード評価システム
- **シナリオ管理**: 戦略→シナリオ→トレードの階層構造
- **Discord配信**: 構造化された売買通知メッセージ
- **リアルタイム監視**: 継続的監視ツールによるシステム状況の可視化
- **日次評価・改善**: ローリング検証によるルール改訂

### 1.3 運用方針
1. **ルールベース中心**: 数値判定はルールベース、LLMは補助的役割
2. **ハード制約**: 1%/trade, 3%/day, 保有30–240分, blackout厳守
3. **トレード記録**: 全トレードのスナップ保存・評価
4. **日次改善**: ルール遵守判定に基づく継続的改善
5. **安全設計**: 下位分位（daily_score_p05）の最大化

### 1.4 LLMの役割（限定）
**LLMは以下の3つの役割に限定**：
- **言語化**: 数値データを人間が理解しやすい文章に変換
- **日誌**: トレード履歴の自然言語での記録・要約
- **改善提案**: パフォーマンス分析結果に基づく改善案の提示

**LLMは行わない**：
- シグナル生成・売買判定
- 数値最適化・パラメータ調整
- 市場分析・予測

### 1.5 対象市場
- **通貨ペア**: USD/JPY
- **時間足**: 5m, 15m, 1h, 4h, 1d
- **分析頻度**: 5分間隔（M5足ベース）
- **トレードスタイル**: 数時間で完結、1日3〜5回程度

### 1.6 現在のシステム状況
- ✅ **イベント駆動アーキテクチャ**: データ収集完了時に自動でテクニカル分析を実行
- ✅ **階層的テクニカル分析**: D1/H4（トレンド）、H1（ゾーン）、M5（タイミング）の3段階分析
- ✅ **ルールベース売買システム**: 5つのアクティブルールによる自動シグナル生成
- ✅ **リアルタイム監視**: 継続的監視ツールによるシステム状況の可視化
- ✅ **Discord通知**: シナリオ作成、エントリー/エグジットシグナルの自動通知
- ✅ **データベースイベントテーブル**: イベント駆動システムの永続化
- ✅ **継続的データ収集**: 5分間隔での自動データ収集とイベント発行

---

## 2. アーキテクチャ設計

### 2.1 モジュール構造
```
modules/llm_analysis/              # 既存フォルダを拡張
├── core/                          # コア機能
│   ├── data_preparator.py         # データ準備器（✅完成済み）
│   ├── technical_calculator.py    # テクニカル指標計算器（✅完成済み）
│   ├── technical_analysis_service.py # テクニカル分析サービス（✅完成済み）
│   ├── rule_engine.py             # ルールベース判定エンジン（✅完成済み）
│   ├── scenario_manager.py        # シナリオ管理システム（✅完成済み）
│   └── snapshot_manager.py        # スナップ保存システム（✅完成済み）
├── providers/                     # 外部API連携
│   ├── yahoo_finance_stream_client.py  # Yahoo Finance Stream API（✅完成済み）
│   ├── oanda_stream_client.py     # OANDA Stream API（将来用）
│   └── base_provider.py           # 共通インターフェース（✅完成済み）
├── services/                      # サービス層（✅完成済み）
│   └── analysis_service.py        # 分析サービス
├── evaluation/                    # 評価・改善システム（✅完成済み）
│   ├── adherence_evaluator.py     # ルール遵守判定
│   ├── daily_evaluator.py         # 日次評価システム
│   └── rule_improver.py           # ルール改善エンジン
├── llm/                          # LLM補助機能（限定・新規追加）
│   ├── language_processor.py      # 言語化処理
│   ├── journal_generator.py       # 日誌生成
│   └── improvement_advisor.py     # 改善提案
├── notification/                  # 通知システム（✅完成済み）
│   ├── discord_notifier.py        # Discord配信
│   └── message_formatter.py       # メッセージフォーマット
├── orchestration/                 # オーケストレーション（✅完成済み）
│   └── trading_pipeline.py        # 売買パイプライン
├── config/                        # 設定管理
│   ├── trading_config.yaml        # 売買設定（新規追加）
│   ├── rules.yaml                 # ルール定義（✅完成済み）
│   └── risk_constraints.yaml      # リスク制約（新規追加）
└── tests/                         # テスト
    ├── test_technical_calculator.py  # ✅完成済み
    ├── test_technical_values.py      # ✅完成済み
    ├── test_rule_engine.py          # 新規追加
    ├── test_scenario_manager.py     # 新規追加
    ├── test_adherence_evaluator.py  # 新規追加
    └── test_oanda_integration.py    # 新規追加
```

### 2.2 主要コンポーネント

#### 2.2.1 ルールベース判定エンジン (RuleEngine)
```python
class RuleBasedEngine:
    """ルールベース判定エンジン"""
    
    def evaluate_entry_conditions(self, data: Dict) -> Dict:
        """エントリー条件の評価"""
    
    def evaluate_exit_conditions(self, trade: Dict) -> Dict:
        """エグジット条件の評価"""
    
    def check_risk_constraints(self, scenario: Dict) -> bool:
        """リスク制約のチェック"""
```

#### 2.2.2 シナリオ管理システム (ScenarioManager)
```python
class ScenarioManager:
    """シナリオ管理システム"""
    
    def create_scenario(self, strategy: str, conditions: Dict) -> Dict:
        """シナリオの作成"""
    
    def update_scenario_status(self, scenario_id: str, status: str) -> None:
        """シナリオステータスの更新"""
    
    def get_active_scenarios(self) -> List[Dict]:
        """アクティブシナリオの取得"""
```

#### 2.2.3 スナップ保存システム (SnapshotManager)
```python
class SnapshotManager:
    """スナップ保存システム"""
    
    def save_entry_snapshot(self, trade: Dict) -> str:
        """エントリースナップの保存"""
    
    def save_exit_snapshot(self, trade_id: str, exit_data: Dict) -> None:
        """エグジットスナップの保存"""
    
    def get_trade_history(self, days: int) -> List[Dict]:
        """トレード履歴の取得"""
```

#### 2.2.4 Yahoo Finance Stream API連携 (YahooFinanceStreamClient)
```python
class YahooFinanceStreamClient:
    """Yahoo Finance Stream API連携（認証不要設計）"""
    
    async def start_price_stream(self, instruments: List[str]) -> None:
        """価格ストリームの開始"""
    
    async def get_current_price(self, instrument: str) -> PriceData:
        """現在価格の取得"""
    
    def add_callback(self, stream_type: StreamType, callback: Callable) -> None:
        """コールバックの追加"""
```

---

## 3. 機能仕様

### 3.1 Stage 1: データ取得・準備

#### 3.1.1 Yahoo Finance Stream API連携
```python
# リアルタイム価格データ取得
{
    "instrument": "USD_JPY",
    "time": "2025-01-04T10:30:00.000000000Z",
    "bid": 146.123,
    "ask": 146.125,
    "status": "tradeable",
    "spread": 0.002,
    "mid_price": 146.124
}

# 価格データ構造
@dataclass
class PriceData:
    instrument: str
    time: datetime
    bid: float
    ask: float
    status: str
    spread: float
    mid_price: float
```

#### 3.1.2 データベース連携
- TimescaleDBから複数時間足の価格データを取得
- テクニカル指標の計算（TA-Lib + フィボナッチ）
- データ品質チェックと前処理

### 3.2 Stage 2: ルールベース判定

#### 3.2.1 エントリー条件ルール（シンプル）
```yaml
# アクティブルール（段階的導入）
active_rules:
  - name: "pullback_buy"
    enabled: true
    conditions:
      - "RSI_14 <= 40"                    # 押し目条件
      - "price > EMA_200"                 # トレンド方向
      - "MACD > MACD_Signal"              # モメンタム
      - "price BETWEEN Fib_0.382 AND Fib_0.618"  # フィボナッチ
      - "active_session = Tokyo OR London"       # セッション
      - "daily_trades < 5"                       # リスク制約
      - "daily_risk < 3%"
  
  - name: "breakout_buy"
    enabled: false  # Week 2で有効化
    conditions:
      - "price > EMA_21"
      - "RSI_14 > 50"
      - "MACD > 0"
      - "price > Fib_1.272"
      - "Volume_Ratio > 1.5"
      - "active_session = London OR NewYork"
      - "daily_trades < 5"
      - "daily_risk < 3%"
  
  - name: "reversal_sell"
    enabled: false  # Week 3で有効化
    conditions:
      - "RSI_14 >= 70"
      - "price < EMA_200"
      - "MACD < MACD_Signal"
      - "price BETWEEN Fib_0.618 AND Fib_0.786"
      - "active_session = Tokyo OR London"
      - "daily_trades < 5"
      - "daily_risk < 3%"
```

#### 3.2.2 エグジット条件ルール
```yaml
exit_rules:
  profit_targets:
    tp1: "price >= entry_price + (ATR * 1.5)"
    tp2: "price >= entry_price + (ATR * 2.5)"
    tp3: "price >= entry_price + (ATR * 4.0)"
    
  stop_loss:
    sl: "price <= entry_price - (ATR * 1.0)"
    
  time_based:
    max_hold_time: "hold_time >= 240 minutes"
    min_hold_time: "hold_time >= 30 minutes"
    
  trailing_stop:
    trailing_activation: "profit >= ATR * 1.0"
    trailing_distance: "ATR * 0.8"
```

### 3.3 Stage 3: シナリオ管理

#### 3.3.1 シナリオライフサイクル
```
planned → armed(監視) → triggered(条件成立) → entered(約定) → exited/canceled/expired
```

#### 3.3.2 シナリオ構造
```python
scenario = {
    "id": "scenario_001",
    "strategy": "pullback_buy",  # 押し目買い
    "status": "armed",
    "conditions": {
        "entry": {...},
        "exit": {...},
        "risk": {...}
    },
    "created_at": "2025-01-04T10:00:00Z",
    "expires_at": "2025-01-04T18:00:00Z",
    "trades": []  # 実際の約定履歴
}
```

### 3.4 Stage 4: スナップ保存

#### 3.4.1 エントリースナップ
```python
entry_snapshot = {
    "trade_id": "trade_001",
    "scenario_id": "scenario_001",
    "timestamp": "2025-01-04T10:30:00Z",
    "price_data": {
        "entry_price": 146.124,
        "bid": 146.123,
        "ask": 146.125
    },
    "technical_indicators": {
        "RSI_14": 38.5,
        "MACD": 0.0012,
        "EMA_21": 146.100,
        "EMA_200": 145.800,
        "ATR_14": 0.45
    },
    "fibonacci_levels": {
        "Fib_0.382": 146.050,
        "Fib_0.5": 146.000,
        "Fib_0.618": 145.950
    },
    "session_info": {
        "session": "Tokyo",
        "time_remaining": 180  # 分
    },
    "risk_metrics": {
        "position_size": 1000,
        "risk_percent": 0.8,
        "daily_risk": 1.2
    }
}
```

#### 3.4.2 エグジットスナップ
```python
exit_snapshot = {
    "trade_id": "trade_001",
    "exit_timestamp": "2025-01-04T12:15:00Z",
    "exit_price": 146.250,
    "exit_reason": "tp1_hit",
    "hold_time_minutes": 105,
    "profit_loss": 126,  # pips
    "profit_loss_percent": 0.86,
    "technical_indicators": {...},  # エグジット時点の指標
    "adherence_score": 95  # ルール遵守スコア
}
```

### 3.5 Stage 5: ルール遵守判定

#### 3.5.1 評価項目（100点満点）
```python
adherence_evaluation = {
    "sma_200_direction": {
        "weight": 20,
        "score": 20,  # 満点
        "violation": None
    },
    "rsi_threshold": {
        "weight": 20,
        "score": 15,  # 5点減点
        "violation": "rsi_was_42_not_40"
    },
    "macd_conditions": {
        "weight": 20,
        "score": 20,  # 満点
        "violation": None
    },
    "fibonacci_zone": {
        "weight": 20,
        "score": 20,  # 満点
        "violation": None
    },
    "risk_management": {
        "weight": 20,
        "score": 18,  # 2点減点
        "violation": "hold_time_105min_vs_120min_target"
    },
    "total_score": 93,
    "violation_tags": ["rsi_threshold", "hold_time"]
}
```

#### 3.5.2 乖離タグ
```python
violation_tags = [
    "early_entry",      # 早期エントリー
    "late_entry",       # 遅延エントリー
    "trend_violation",  # トレンド違反
    "rule_conflict_sl", # ストップロスルール違反
    "over_hold_time",   # 保有時間超過
    "news_blackout",    # ニュース期間中
    "correlation_risk", # 相関リスク超過
    "daily_limit"       # 日次制限超過
]
```

### 3.6 Stage 6: LLM補助機能（限定）

#### 3.6.1 言語化処理
```python
class LanguageProcessor:
    """数値データの言語化処理"""
    
    def describe_trade_snapshot(self, snapshot: Dict) -> str:
        """トレードスナップの言語化"""
        return f"""
        エントリー価格: {snapshot['entry_price']}で{snapshot['direction']}ポジションを開始。
        RSI: {snapshot['rsi']}、MACD: {snapshot['macd']}、EMA200: {snapshot['ema_200']}。
        フィボナッチレベル: {snapshot['fibonacci_position']}。
        セッション: {snapshot['session']}、リスク: {snapshot['risk_percent']}%。
        """
    
    def describe_performance(self, metrics: Dict) -> str:
        """パフォーマンス指標の言語化"""
        return f"""
        本日のパフォーマンス: 勝率{metrics['win_rate']}%、総利益{metrics['total_profit']}pips。
        最大ドローダウン: {metrics['max_drawdown']}%、シャープレシオ: {metrics['sharpe_ratio']}。
        ルール遵守スコア: {metrics['adherence_score']}/100。
        """
```

#### 3.6.2 日誌生成
```python
class JournalGenerator:
    """トレード日誌の生成"""
    
    def generate_daily_journal(self, trades: List[Dict]) -> str:
        """日次トレード日誌の生成"""
        return f"""
        【{datetime.now().strftime('%Y年%m月%d日')} トレード日誌】
        
        総トレード数: {len(trades)}件
        成功トレード: {len([t for t in trades if t['profit'] > 0])}件
        失敗トレード: {len([t for t in trades if t['profit'] <= 0])}件
        
        主要なトレード:
        {self._format_trade_summaries(trades)}
        
        今日の学び:
        {self._generate_insights(trades)}
        """
    
    def generate_rule_performance_journal(self, rule_performance: Dict) -> str:
        """ルールパフォーマンス日誌の生成"""
        return f"""
        【ルールパフォーマンス分析】
        
        押し目買いルール: 勝率{rule_performance['pullback_buy']['win_rate']}%
        ブレイクアウト買いルール: 勝率{rule_performance['breakout_buy']['win_rate']}%
        
        改善点:
        {self._generate_improvement_suggestions(rule_performance)}
        """
```

#### 3.6.3 改善提案
```python
class ImprovementAdvisor:
    """改善提案の生成"""
    
    def suggest_rule_improvements(self, performance_data: Dict) -> List[str]:
        """ルール改善提案の生成"""
        suggestions = []
        
        if performance_data['pullback_buy']['win_rate'] < 0.6:
            suggestions.append("押し目買いルールのRSI閾値を40から35に下げることを検討してください")
        
        if performance_data['false_positive_rate'] > 0.25:
            suggestions.append("ボリューム条件を追加して偽シグナルを減らすことを検討してください")
        
        if performance_data['max_drawdown'] > 0.05:
            suggestions.append("ストップロスをATR*1.0からATR*0.8に縮小することを検討してください")
        
        return suggestions
    
    def suggest_parameter_adjustments(self, backtest_results: Dict) -> Dict:
        """パラメータ調整提案の生成"""
        return {
            "rsi_threshold": {
                "current": 40,
                "suggested": 35,
                "reason": "過去30日間のデータ分析により、RSI閾値35でより高い勝率が期待される",
                "confidence": 0.85
            },
            "atr_multiplier": {
                "current": 1.5,
                "suggested": 1.8,
                "reason": "リスクリワード比の改善により、ATR倍率1.8でより良い結果が期待される",
                "confidence": 0.78
            }
        }
```

### 3.7 Stage 7: Discord配信

#### 3.7.1 シナリオ作成通知
```python
SCENARIO_CREATED_FORMAT = """
🟡 **SCENARIO CREATED** 🟡
📊 **USD/JPY** | {strategy}
⏰ **作成時刻**: {timestamp}

🎯 **シナリオID**: {scenario_id}
📋 **戦略**: {strategy_name}
⏱️ **有効期限**: {expires_at}

💡 **エントリー条件**: {entry_conditions}
👀 **監視中**: {monitoring_status}
⚠️ **リスク制約**: {risk_constraints}

🔍 **テクニカル状況**: {technical_summary}
📈 **現在価格**: {current_price}
```
```

#### 3.7.2 エントリー通知
```python
ENTRY_NOTIFICATION_FORMAT = """
🟢 **ENTRY SIGNAL** 🟢
📊 **USD/JPY** | {strategy}
⏰ **時刻**: {timestamp}

🎯 **エントリー**: {direction} @ {entry_price}
🛑 **SL**: {stop_loss} ({sl_pips} pips)
💰 **TP1**: {tp1} ({tp1_pips} pips)
💰 **TP2**: {tp2} ({tp2_pips} pips)
💰 **TP3**: {tp3} ({tp3_pips} pips)

📈 **確率**: {probability}% | **RR**: {risk_reward}
⏱️ **最大保有**: {max_hold_time}分
🎯 **シナリオID**: {scenario_id}

💡 **根拠**: {rule_summary}
🔍 **テクニカル**: {technical_summary}
⚠️ **リスク**: {risk_factors}
"""
```

#### 3.7.3 エグジット通知
```python
EXIT_NOTIFICATION_FORMAT = """
🔴 **EXIT SIGNAL** 🔴
📊 **USD/JPY** | {scenario_id}
⏰ **時刻**: {timestamp}

💰 **エグジット**: {exit_price}
📈 **P&L**: {profit_loss} pips ({profit_loss_percent}%)
⏱️ **保有時間**: {hold_time}分
🎯 **エグジット理由**: {exit_reason}

📊 **ルール遵守スコア**: {adherence_score}/100
🏷️ **違反タグ**: {violation_tags}

💡 **分析**: {analysis_summary}
```

---

## 4. データフロー

### 4.1 ルールベース売買パイプライン（イベント駆動アーキテクチャ）
```
データ収集完了イベント → テクニカル分析 → ルールベース判定 → シナリオ管理 → Discord配信
       ↓                    ↓              ↓              ↓
   イベントテーブル      階層的分析      エントリー/エグジット    スナップ保存
       ↓                    ↓              ↓              ↓
   イベント監視        テクニカル指標計算    ルール遵守判定      日次評価・改善
       ↓                    ↓              ↓              ↓
   継続的監視ツール      分析結果保存      パフォーマンス追跡    ルール改善提案
```

### 4.2 処理フロー（イベント駆動）
1. **データ収集**: 5分間隔でYahoo Finance API + TimescaleDB（認証不要）
2. **イベント発行**: データ収集完了時にイベントテーブルに記録
3. **イベント監視**: 分析サービスがイベントを監視・処理
4. **テクニカル指標計算**: TA-Lib + フィボナッチ（階層的分析）
5. **ルールベース判定**: エントリー/エグジット条件チェック
6. **シナリオ管理**: ライフサイクル管理
7. **シナリオ作成通知**: Discord配信（シナリオ作成時）
8. **スナップ保存**: エントリー/エグジット時点の記録
9. **Discord配信**: 売買シグナル通知（エントリー/エグジット時）
10. **ルール遵守判定**: 100点満点評価
11. **LLM補助処理**: 言語化・日誌生成・改善提案
12. **日次評価**: パフォーマンス分析・ルール改善
13. **継続的監視**: リアルタイム監視ツールによるシステム状況の可視化

### 4.3 エラーハンドリング
- **Yahoo Finance APIエラー**: 再接続・フォールバック（認証不要）
- **ルール判定エラー**: デフォルト値・ログ記録
- **配信エラー**: リトライ・アラート通知

---

## 5. API仕様

### 5.1 Yahoo Finance Stream API（認証不要設計）
```python
class YahooFinanceStreamClient:
    async def start_price_stream(self, instruments: List[str]) -> None:
        """価格ストリームの開始"""
    
    async def get_current_price(self, instrument: str) -> PriceData:
        """現在価格の取得"""
    
    def add_callback(self, stream_type: StreamType, callback: Callable) -> None:
        """コールバックの追加"""
    
    async def initialize(self) -> None:
        """初期化（認証不要）"""
```

### 5.2 ルールエンジンAPI
```python
class RuleBasedEngine:
    def evaluate_conditions(self, data: Dict, rule_set: str) -> Dict:
        """条件評価"""
    
    def check_constraints(self, scenario: Dict) -> bool:
        """制約チェック"""
    
    def calculate_risk_metrics(self, trade: Dict) -> Dict:
        """リスク指標計算"""
```

### 5.3 Discord API
```python
class DiscordNotifier:
    async def send_scenario_created(self, scenario: Dict) -> bool:
        """シナリオ作成通知送信"""
    
    async def send_entry_signal(self, signal: Dict) -> bool:
        """エントリーシグナル送信"""
    
    async def send_exit_signal(self, signal: Dict) -> bool:
        """エグジットシグナル送信"""
    
    async def send_daily_report(self, report: Dict) -> bool:
        """日次レポート送信"""
```

---

## 6. 設定仕様

### 6.1 売買設定 (trading_config.yaml)
```yaml
# 基本設定
trading:
  symbol: "USD_JPY"
  account_id: "${OANDA_ACCOUNT_ID}"
  access_token: "${OANDA_ACCESS_TOKEN}"
  environment: "practice"  # practice/live
  
# リスク管理
risk_management:
  max_risk_per_trade: 1.0  # %
  max_risk_per_day: 3.0    # %
  max_trades_per_day: 5
  max_hold_time_minutes: 240
  min_hold_time_minutes: 30
  correlation_threshold: 0.7

# セッション設定
sessions:
  tokyo:
    start: "09:00"
    end: "15:00"
    timezone: "JST"
  london:
    start: "16:00"
    end: "24:00"
    timezone: "JST"
  new_york:
    start: "22:00"
    end: "06:00"
    timezone: "JST"

# ニュースブラックアウト
news_blackout:
  - start: "2025-01-04T21:30:00Z"
    end: "2025-01-04T22:00:00Z"
    event: "NFP"
  - start: "2025-01-04T14:00:00Z"
    end: "2025-01-04T14:30:00Z"
    event: "FOMC"

# テクニカル指標設定
technical_indicators:
  rsi:
    period: 14
    oversold: 30
    overbought: 70
  macd:
    fast: 12
    slow: 26
    signal: 9
  ema:
    short: 21
    medium: 55
    long: 200
  atr:
    period: 14
    multiplier: 1.0
```

### 6.2 ルール定義 (rules.yaml)
```yaml
# アクティブルール（シンプルな設定）
active_rules:
  - name: "pullback_buy"
    enabled: true
    description: "押し目買い"
    conditions:
      - "RSI_14 <= 40"
      - "price > EMA_200"
      - "MACD > MACD_Signal"
      - "price BETWEEN Fib_0.382 AND Fib_0.618"
      - "active_session = Tokyo OR London"
      - "daily_trades < 5"
      - "daily_risk < 3%"
  
  - name: "breakout_buy"
    enabled: false  # 段階的導入
    description: "ブレイクアウト買い"
    conditions:
      - "price > EMA_21"
      - "RSI_14 > 50"
      - "MACD > 0"
      - "price > Fib_1.272"
      - "Volume_Ratio > 1.5"
      - "active_session = London OR NewYork"
      - "daily_trades < 5"
      - "daily_risk < 3%"
  
  - name: "reversal_sell"
    enabled: false  # 段階的導入
    description: "逆張り売り"
    conditions:
      - "RSI_14 >= 70"
      - "price < EMA_200"
      - "MACD < MACD_Signal"
      - "price BETWEEN Fib_0.618 AND Fib_0.786"
      - "active_session = Tokyo OR London"
      - "daily_trades < 5"
      - "daily_risk < 3%"

# エグジットルール（共通）
exit_rules:
  profit_targets:
    tp1:
      condition: "price >= entry_price + (ATR * 1.5)"
      action: "close_50_percent"
    tp2:
      condition: "price >= entry_price + (ATR * 2.5)"
      action: "close_30_percent"
    tp3:
      condition: "price >= entry_price + (ATR * 4.0)"
      action: "close_remaining"
  
  stop_loss:
    sl:
      condition: "price <= entry_price - (ATR * 1.0)"
      action: "close_all"
  
  time_based:
    max_hold:
      condition: "hold_time >= 240 minutes"
      action: "close_all"
    min_hold:
      condition: "hold_time >= 30 minutes"
      action: "allow_exit"

# パラメータ設定（簡単に調整可能）
parameters:
  rsi_oversold: 40
  rsi_overbought: 70
  atr_stop_loss: 1.0
  atr_take_profit_1: 1.5
  atr_take_profit_2: 2.5
  atr_take_profit_3: 4.0
  ema_short: 21
  ema_medium: 55
  ema_long: 200
```

### 6.3 Discord設定
```yaml
discord:
  webhook_url: "${DISCORD_WEBHOOK_URL}"
  channel_id: "${DISCORD_CHANNEL_ID}"
  thread_creation: true
  message_formatting: true
  
  # 通知設定
  notifications:
    scenario_created: true    # シナリオ作成時
    entry_signals: true       # エントリー時
    exit_signals: true        # エグジット時
    daily_reports: true       # 日次レポート
    error_alerts: true        # エラーアラート
    
  # メッセージ設定
  message_settings:
    embed_color_scenario: 0xffff00  # 黄（シナリオ作成）
    embed_color_entry: 0x00ff00     # 緑（エントリー）
    embed_color_exit: 0xff0000      # 赤（エグジット）
    embed_color_report: 0x0099ff    # 青（レポート）
    include_technical_details: true
    include_risk_metrics: true
```

---

## 7. 実装計画

### 7.1 Phase 1: 基盤構築（✅完了）
- [x] 既存llm_analysisフォルダの拡張
- [x] Yahoo Finance Stream API連携の実装（認証不要）
- [x] データベース連携型データ準備器の実装
- [x] 既存テクニカル指標計算器の統合（✅完成済み）
- [x] 基本テストの実装

### 7.2 Phase 2: ルールエンジン（✅完了）
- [x] ルールベース判定エンジンの実装
- [x] シナリオ管理システムの実装
- [x] スナップ保存システムの実装
- [x] リスク制約チェック機能
- [x] シンプルなルール管理システムの実装

### 7.3 Phase 3: 評価・改善システム（✅完了）
- [x] ルール遵守判定システムの実装
- [x] 日次評価システムの実装
- [x] シンプルなルール改善提案システム
- [x] パフォーマンス分析機能
- [x] 統計レポート生成

### 7.4 Phase 4: イベント駆動アーキテクチャ（✅完了）
- [x] データベースイベントテーブルの作成
- [x] データ収集サービスにイベント発行機能を追加
- [x] 独立した分析サービス（イベント監視）の作成
- [x] テクニカル分析サービスの実装
- [x] イベント駆動システムのテスト

### 7.5 Phase 5: 通知・配信（✅完了）
- [x] Discord配信システムの実装
- [x] メッセージフォーマッターの実装
- [x] シナリオ作成/エントリー/エグジット通知
- [x] 日次レポート配信
- [x] エラーアラート機能

### 7.6 Phase 6: 統合・最適化（✅完了）
- [x] 売買パイプライン統合
- [x] イベント駆動システムの統合
- [x] 継続的監視ツールの実装
- [x] 統合テスト
- [x] 運用テスト

### 7.7 Phase 7: LLM補助機能（未実装）
- [ ] 言語化処理システムの実装
- [ ] 日誌生成システムの実装
- [ ] 改善提案システムの実装
- [ ] LLM API連携（OpenAI/Anthropic）
- [ ] 自然言語レポート生成

### 7.8 段階的ルール導入計画（現在の状況）
- [x] **Week 1**: pullback_buy のみで運用開始（✅完了）
- [x] **Week 2**: breakout_buy を有効化（✅完了）
- [x] **Week 3**: reversal_sell を有効化（✅完了）
- [x] **Week 4**: パラメータ最適化（✅完了）
- [x] **Week 5**: イベント駆動アーキテクチャの実装（✅完了）
- [x] **Week 6**: 継続的監視システムの実装（✅完了）

### 7.9 現在の運用状況
- ✅ **データ収集デーモン**: 5分間隔でデータ収集・イベント発行
- ✅ **テクニカル分析サービス**: イベント駆動で自動分析実行
- ✅ **ルールエンジン**: 5つのアクティブルールでシグナル生成
- ✅ **シナリオ管理**: エントリーからエグジットまでの完全管理
- ✅ **Discord通知**: シナリオ作成・シグナル通知の自動配信
- ✅ **継続的監視**: リアルタイム監視ツールによるシステム状況の可視化

---

## 8. 品質要件

### 8.1 パフォーマンス要件
- **価格更新応答**: 100ms以内
- **ルール判定**: 50ms以内
- **配信時間**: 5秒以内
- **日次評価**: 30秒以内

### 8.2 可用性要件
- **システム可用性**: 99.9%以上
- **OANDA API可用性**: 99.5%以上
- **Discord配信成功率**: 95%以上

### 8.3 品質要件
- **ルール遵守率**: 90%以上
- **配信精度**: 95%以上
- **エラー率**: 1%以下
- **データ整合性**: 100%

### 8.4 セキュリティ要件
- **API キー管理**: 環境変数での管理
- **データ暗号化**: 通信の暗号化
- **アクセス制御**: 適切な権限管理
- **監査ログ**: 全操作の記録

---

## 9. 監視・ログ

### 9.1 監視項目
- **データ収集状況**: 各時間足の最新データ時刻とレコード数
- **イベント処理状況**: データ収集完了イベントの処理状況
- **分析結果**: テクニカル分析の実行結果と条件合致状況
- **シナリオ状況**: 作成されたシナリオの情報とステータス
- **システムヘルス**: 全体的なシステムの健全性
- **ルール判定時間**: 各ルールの評価時間
- **シナリオ成功率**: シナリオの成功率
- **配信成功率**: Discord配信の成功率
- **ルール遵守率**: 日次ルール遵守率

### 9.2 ログ仕様
```python
# ログレベル
LOGGING_LEVELS = {
    "DEBUG": "詳細なデバッグ情報",
    "INFO": "一般的な情報",
    "WARNING": "警告情報",
    "ERROR": "エラー情報",
    "CRITICAL": "重大なエラー"
}

# ログ出力項目
LOG_FIELDS = [
    "timestamp", "level", "module", "function", 
    "message", "trade_id", "scenario_id", "adherence_score"
]
```

---

## 10. テスト戦略

### 10.1 テスト階層
- **単体テスト**: 各コンポーネントの個別テスト
- **統合テスト**: コンポーネント間の連携テスト
- **E2Eテスト**: 全体フローのテスト
- **パフォーマンステスト**: 負荷・応答時間テスト

### 10.2 テストカバレッジ
- **コードカバレッジ**: 85%以上
- **機能カバレッジ**: 100%
- **APIカバレッジ**: 100%
- **ルールカバレッジ**: 100%

---

## 11. 現在の開発状況サマリー

### 11.1 完了済み機能
- ✅ **イベント駆動アーキテクチャ**: データ収集完了時の自動テクニカル分析
- ✅ **階層的テクニカル分析**: D1/H4（トレンド）、H1（ゾーン）、M5（タイミング）
- ✅ **ルールベース売買システム**: 5つのアクティブルール
- ✅ **シナリオ管理システム**: エントリーからエグジットまでの完全管理
- ✅ **Discord通知システム**: シナリオ作成・シグナル通知の自動配信
- ✅ **継続的監視ツール**: リアルタイム監視と日本時間表示
- ✅ **データベースイベントテーブル**: イベント駆動システムの永続化

### 11.2 現在運用中のシステム
1. **データ収集デーモン** (`start_event_driven_system.py`)
   - 5分間隔でデータ収集
   - イベント駆動でテクニカル分析実行
   - シナリオ作成とDiscord通知

2. **継続的監視ツール** (`continuous_monitor.py`)
   - 10秒間隔でシステム状況を監視
   - 日本時間表示でリアルタイム監視
   - データ更新状況の可視化

### 11.3 アクティブルール
- **pullback_buy**: 押し目買い（RSI ≤ 40, 価格 > EMA200）
- **reversal_sell**: 逆張り売り（RSI ≥ 70, 価格 < EMA200）
- **trend_follow_sell**: 下降トレンドフォロー売り
- **strong_downtrend_sell**: 強い下降トレンド売り（RSI 25-40）

### 11.4 未実装機能
- **LLM補助機能**: 言語化・日誌生成・改善提案
- **追加テスト**: 統合テスト・パフォーマンステスト

---

**文書管理情報**

- 文書ID: RULE-BASED-TRADING-SPEC-001
- バージョン: v3.0
- 作成日: 2025-01-04
- 最終更新: 2025-09-18
- 承認者: [システム設計者]
- 次回レビュー予定: 2025-10-18
