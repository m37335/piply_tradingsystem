# OANDAãƒ‡ãƒ¢è¬›åº§ç™»éŒ²ã¨Stream APIè¨­å®šã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ‡ãƒ¢è¬›åº§ã®ç™»éŒ²](#1-ãƒ‡ãƒ¢è¬›åº§ã®ç™»éŒ²)
2. [APIã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—](#2-apiã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—)
3. [Stream APIã®ç¢ºèª](#3-stream-apiã®ç¢ºèª)
4. [ç’°å¢ƒå¤‰æ•°ã®è¨­å®š](#4-ç’°å¢ƒå¤‰æ•°ã®è¨­å®š)
5. [å‹•ä½œç¢ºèª](#5-å‹•ä½œç¢ºèª)

---

## 1. ãƒ‡ãƒ¢è¬›åº§ã®ç™»éŒ²

### 1.1 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ

1. **ãƒ‡ãƒ¢è¬›åº§ç”³è¾¼ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹**
   - [OANDAè¨¼åˆ¸ ç„¡æ–™ãƒ‡ãƒ¢è¬›åº§ã®é–‹è¨­](https://www.oanda.jp/trade/web/openAccount/mailAddressCheck?type=Demo)

2. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›**
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

3. **ãƒ¡ãƒ¼ãƒ«ç¢ºèª**
   - å±Šã„ãŸãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
   - åˆ©ç”¨è¦ç´„ã®ç¢ºèªã¨å¿…è¦æƒ…å ±ã®å…¥åŠ›

4. **ç™»éŒ²å®Œäº†**
   - ã€Œç„¡æ–™ãƒ‡ãƒ¢è¬›åº§ã‚’é–‹è¨­ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¨˜è¼‰ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ãŒå±Šã

5. **ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - [ãƒã‚¤ãƒšãƒ¼ã‚¸](https://www.oanda.jp/trade/web/fxTradeLogin.do)ã«ãƒ­ã‚°ã‚¤ãƒ³
   - ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ

### 1.2 æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ

1. **ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ãƒ­ã‚°ã‚¤ãƒ³**
   - [ãƒã‚¤ãƒšãƒ¼ã‚¸](https://www.oanda.jp/trade/web/fxTradeLogin.do)ã«ãƒ­ã‚°ã‚¤ãƒ³

2. **ãƒ‡ãƒ¢è¬›åº§ç”³è¾¼**
   - å³ä¸Šã®ã€Œãƒ‡ãƒ¢è¬›åº§ã®æ–°è¦ãŠç”³ã—è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ç”³è¾¼ã‚’è¡Œã†

3. **ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - ãƒ‡ãƒ¢ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ

---

## 2. APIã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—

### 2.1 ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œ

1. **ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ãƒ­ã‚°ã‚¤ãƒ³**
   - [ãƒã‚¤ãƒšãƒ¼ã‚¸](https://www.oanda.jp/trade/web/fxTradeLogin.do)ã«ãƒ­ã‚°ã‚¤ãƒ³

2. **APIã‚¢ã‚¯ã‚»ã‚¹ã®ç®¡ç†**
   - ã€ŒAPIã‚¢ã‚¯ã‚»ã‚¹ã®ç®¡ç†ã€ã¾ãŸã¯ã€ŒAPIè¨­å®šã€ã«ã‚¢ã‚¯ã‚»ã‚¹

3. **ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ**
   - ã€Œãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã€ŒTrading Systemã€ï¼‰
   - ç™ºè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

4. **ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜**
   - ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ãªå ´æ‰€ã«ä¿å­˜
   - **é‡è¦**: ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“

### 2.2 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã®ç¢ºèª

1. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®ç¢ºèª**
   - ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã€ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’ç¢ºèª
   - å½¢å¼ä¾‹ï¼š`101-001-123456-001`

---

## 3. Stream APIã®ç¢ºèª

### 3.1 APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

- **ãƒ‡ãƒ¢ç’°å¢ƒï¼ˆfxTrade Practiceï¼‰**:
  - REST API: `https://api-fxpractice.oanda.com`
  - Streaming API: `https://stream-fxpractice.oanda.com`

- **æœ¬ç•ªç’°å¢ƒï¼ˆfxTradeï¼‰**:
  - REST API: `https://api-fxtrade.oanda.com`
  - Streaming API: `https://stream-fxtrade.oanda.com`

### 3.2 ä¾¡æ ¼ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
GET /v3/accounts/{accountID}/pricing/stream
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `instruments`: é€šè²¨ãƒšã‚¢ï¼ˆä¾‹ï¼š`USD_JPY`ï¼‰
- `snapshot`: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆ`true`/`false`ï¼‰

**ä¾‹**:
```
https://stream-fxpractice.oanda.com/v3/accounts/101-001-123456-001/pricing/stream?instruments=USD_JPY&snapshot=true
```

### 3.3 èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼

```
Authorization: Bearer YOUR_PERSONAL_ACCESS_TOKEN
Content-Type: application/json
```

---

## 4. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

### 4.1 .envãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

`/app/.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ï¼š

```bash
# OANDAè¨­å®š
OANDA_ACCOUNT_ID=101-001-123456-001
OANDA_ACCESS_TOKEN=your_personal_access_token_here
OANDA_ENVIRONMENT=practice
```

### 4.2 è¨­å®šå€¤ã®èª¬æ˜

- `OANDA_ACCOUNT_ID`: ãƒ‡ãƒ¢è¬›åº§ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
- `OANDA_ACCESS_TOKEN`: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
- `OANDA_ENVIRONMENT`: `practice`ï¼ˆãƒ‡ãƒ¢ç’°å¢ƒï¼‰ã¾ãŸã¯ `live`ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

---

## 5. å‹•ä½œç¢ºèª

### 5.1 åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ

```bash
cd /app
python -c "
import asyncio
import aiohttp
import ssl
import json
import os
from dotenv import load_dotenv

load_dotenv()

async def test_oanda_connection():
    account_id = os.getenv('OANDA_ACCOUNT_ID')
    access_token = os.getenv('OANDA_ACCESS_TOKEN')
    
    if not account_id or not access_token:
        print('âŒ OANDAè¨­å®šãŒä¸å®Œå…¨ã§ã™')
        print('   OANDA_ACCOUNT_ID:', account_id)
        print('   OANDA_ACCESS_TOKEN:', 'è¨­å®šæ¸ˆã¿' if access_token else 'æœªè¨­å®š')
        return
    
    ssl_context = ssl.create_default_context()
    ssl_context.check_hostname = False
    ssl_context.verify_mode = ssl.CERT_NONE
    
    connector = aiohttp.TCPConnector(ssl=ssl_context)
    timeout = aiohttp.ClientTimeout(total=10, connect=5)
    
    async with aiohttp.ClientSession(
        connector=connector,
        timeout=timeout,
        headers={
            'Authorization': f'Bearer {access_token}',
            'Content-Type': 'application/json'
        }
    ) as session:
        try:
            url = f'https://stream-fxpractice.oanda.com/v3/accounts/{account_id}/pricing/stream'
            params = {'instruments': 'USD_JPY', 'snapshot': 'true'}
            
            print(f'ğŸ“¡ æ¥ç¶šãƒ†ã‚¹ãƒˆ: {url}')
            
            async with session.get(url, params=params) as response:
                print(f'ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {response.status}')
                
                if response.status == 200:
                    print('âœ… æ¥ç¶šæˆåŠŸï¼')
                    count = 0
                    async for line in response.content:
                        if line and count < 2:
                            try:
                                data = json.loads(line.decode('utf-8'))
                                print(f'ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿: {json.dumps(data, indent=2, ensure_ascii=False)}')
                                count += 1
                            except json.JSONDecodeError:
                                pass
                        elif count >= 2:
                            break
                else:
                    error_text = await response.text()
                    print(f'âŒ æ¥ç¶šå¤±æ•—: {error_text}')
                    
        except Exception as e:
            print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')

asyncio.run(test_oanda_connection())
"
```

### 5.2 ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
cd /app
python -c "
import asyncio
import sys
sys.path.append('/app')

async def test():
    from modules.llm_analysis.providers.oanda_rest_client import OANDARestClient
    
    client = OANDARestClient()
    
    try:
        await client.initialize()
        
        # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®å–å¾—
        account_info = await client.get_account_info()
        if account_info:
            print(f'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å–å¾—æˆåŠŸ:')
            print(f'   ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID: {account_info.account_id}')
            print(f'   æ®‹é«˜: {account_info.balance}')
            print(f'   é€šè²¨: {account_info.currency}')
        else:
            print('âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å–å¾—å¤±æ•—')
        
        # ç¾åœ¨ä¾¡æ ¼ã®å–å¾—
        prices = await client.get_current_prices(['USD_JPY'])
        if prices:
            usd_jpy = prices.get('USD_JPY', {})
            print(f'âœ… ç¾åœ¨ä¾¡æ ¼å–å¾—æˆåŠŸ:')
            print(f'   USD/JPY: {usd_jpy.get(\"mid\", 0):.5f}')
        else:
            print('âŒ ç¾åœ¨ä¾¡æ ¼å–å¾—å¤±æ•—')
            
    except Exception as e:
        print(f'âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
    finally:
        await client.close()

asyncio.run(test())
"
```

---

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 6.1 ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

**401 Unauthorized**:
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ããªã„
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDãŒé–“é•ã£ã¦ã„ã‚‹
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹

**403 Forbidden**:
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«APIã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„
- ãƒ‡ãƒ¢è¬›åº§ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„

**404 Not Found**:
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDãŒå­˜åœ¨ã—ãªã„
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒé–“é•ã£ã¦ã„ã‚‹

### 6.2 ç¢ºèªäº‹é …

1. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹**: ãƒ‡ãƒ¢è¬›åº§ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹
2. **APIæ¨©é™**: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã‹
3. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‹
4. **SSLè¨¼æ˜æ›¸**: é–‹ç™ºç’°å¢ƒã§ã®SSLè¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼

---

## 7. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

OANDAã®è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š

1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼å–å¾—**: Stream APIã«ã‚ˆã‚‹ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
2. **å–å¼•å®Ÿè¡Œ**: REST APIã«ã‚ˆã‚‹æ³¨æ–‡ã®å®Ÿè¡Œ
3. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†**: æ®‹é«˜ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³ã®ç¢ºèª
4. **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ**: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ã¨ã®é€£æº

---

**æ³¨æ„**: ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ãƒ‡ãƒ¢ç’°å¢ƒç”¨ã§ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€é©åˆ‡ãªãƒªã‚¹ã‚¯ç®¡ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
