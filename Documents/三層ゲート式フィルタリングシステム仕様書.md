# 三層ゲート式フィルタリングシステム仕様書

**作成日**: 2025年9月18日  
**最終更新**: 2025年9月18日  
**バージョン**: v1.0  
**対象モジュール**: llm_analysis（ルールベース売買システム拡張）  
**目的**: 三層ゲート式フィルタリングシステムの詳細仕様と実装指針

---

## 📋 目次

1. [システム概要](#1-システム概要)
2. [アーキテクチャ設計](#2-アーキテクチャ設計)
3. [各ゲートの詳細仕様](#3-各ゲートの詳細仕様)
4. [設定ファイル仕様](#4-設定ファイル仕様)
5. [実装仕様](#5-実装仕様)
6. [データフロー](#6-データフロー)
7. [API仕様](#7-api仕様)
8. [テスト仕様](#8-テスト仕様)
9. [運用仕様](#9-運用仕様)
10. [実装計画](#10-実装計画)

---

## 1. システム概要

### 1.1 目的
現在のパターン検出システムのシグナル生成率0%という課題を解決するため、市場環境を段階的にフィルタリングする三層ゲート式システムを導入する。

### 1.2 基本概念
- **GATE 1**: 環境認識ゲート（マクロフィルター）
- **GATE 2**: シナリオ選定ゲート（セットアップフィルター）
- **GATE 3**: トリガーゲート（タイミングフィルター）

### 1.3 期待効果
- シグナル生成率の向上
- ノイズの大幅削減
- 勝率とリスクリワードの向上
- ロジックの明確化

---

## 2. アーキテクチャ設計

### 2.1 システム構成
```
既存システム（並行運用）
├── start_event_driven_system.py          # 既存システム
├── continuous_monitor.py                 # 既存監視
└── modules/llm_analysis/
    ├── core/rule_engine.py               # 既存ルールエンジン

新システム
├── start_three_gate_system.py            # 新システム起動
├── continuous_monitor_v2.py              # 新システム監視
├── compare_systems.py                    # システム比較
└── modules/llm_analysis/
    ├── core/
    │   ├── three_gate_engine.py          # 三層ゲートエンジン
    │   └── pattern_loader.py             # パターン設定読み込み
    ├── config/
    │   ├── gate1_environment_patterns.yaml
    │   ├── gate2_scenario_patterns.yaml
    │   └── gate3_trigger_patterns.yaml
    └── services/
        └── three_gate_analysis_service.py
```

### 2.2 データフロー
```
データ収集 → テクニカル指標計算 → GATE 1 → GATE 2 → GATE 3 → シグナル生成
     ↓              ↓              ↓       ↓       ↓         ↓
 既存システム    既存計算器      環境認識   シナリオ   トリガー   新シグナル
```

---

## 3. 各ゲートの詳細仕様

### 3.1 GATE 1: 環境認識ゲート

#### 3.1.1 目的
「そもそも取引を検討すべき市場か？」を判断する最上位フィルター

#### 3.1.2 使用時間足
- **主要**: 1d（日足）
- **補助**: 4h（4時間足）

#### 3.1.3 検出パターン

##### パターン1: 確度の高いトレンド相場
```yaml
name: "trending_market"
description: "疑いのない、継続的な一方向の動きを特定"

bullish_trend:
  conditions:
    - price_above_ema200: "close > EMA_200"
    - recent_closes_consistent: "直近3本の日足終値がすべてEMA_200を上回る"
    - strong_trend_adx: "ADX > 25"
  confidence_threshold: 0.7

bearish_trend:
  conditions:
    - price_below_ema200: "close < EMA_200"
    - recent_closes_consistent: "直近3本の日足終値がすべてEMA_200を下回る"
    - strong_trend_adx: "ADX > 25"
  confidence_threshold: 0.7
```

##### パターン2: トレンド転換の初動
```yaml
name: "trend_reversal"
description: "大きな流れが反転する、高期待値の初期段階を捉える"

bullish_reversal:
  conditions:
    - was_bearish_monthly: "過去1ヶ月間、価格は主にEMA_200の下で推移"
    - recent_break_above: "直近で価格がEMA_200を終値で明確に上抜け"
    - macd_bullish: "MACDがゴールデンクロス、またはヒストグラムがプラス圏に転換"
  confidence_threshold: 0.6

bearish_reversal:
  conditions:
    - was_bullish_monthly: "過去1ヶ月間、価格は主にEMA_200の上で推移"
    - recent_break_below: "直近で価格がEMA_200を終値で明確に下抜け"
    - macd_bearish: "MACDがデッドクロス、またはヒストグラムがマイナス圏に転換"
  confidence_threshold: 0.6
```

##### パターン3: 明確なレンジ相場
```yaml
name: "ranging_market"
description: "トレンドフォロー戦略を確実に除外すべき相場を定義"

conditions:
  - weak_trend_adx: "ADX < 20"
  - consistently_weak: "ADX < 20 が5日間以上継続"
  - price_oscillation: "価格がEMA_200を何度もまたいでいる"
confidence_threshold: 0.6
additional_data:
  - range_high: "レンジ上限の計算"
  - range_low: "レンジ下限の計算"
```

### 3.2 GATE 2: シナリオ選定ゲート

#### 3.2.1 目的
GATE 1の判定結果に基づき、有効なシナリオのみを監視する戦略の心臓部

#### 3.2.2 使用時間足
- **主要**: 1h（1時間足）
- **補助**: 4h（4時間足）

#### 3.2.3 環境連動シナリオ

##### トレンド相場でのシナリオ
```yaml
trending_market:
  pullback_setup:
    name: "優位性の高い押し目/戻り"
    conditions:
      - in_pullback_zone: "H1.priceがH1.EMA_55とH1.EMA_21の間のゾーン"
      - not_overheated: "H1.Stochastic_14が過熱感のない領域"
      - rsi_not_extreme: "RSI_14が30-70の範囲"
    confidence_threshold: 0.6
  
  breakout_setup:
    name: "ブレイクアウト準備完了"
    conditions:
      - bollinger_compression: "H1.Bollinger_Bandsの幅が過去100本で最小水準"
      - volume_declining: "ボリュームが減少傾向"
      - price_near_middle: "価格がボリンジャーバンド中央付近"
    confidence_threshold: 0.7
```

##### トレンド転換でのシナリオ
```yaml
trend_reversal:
  first_pullback:
    name: "最初の押し目/戻り"
    conditions:
      - retest_ema: "転換後、初めてH1.EMA_55などの主要移動平均線に引きつけ"
      - volume_confirmation: "ボリュームでの確認"
      - momentum_alignment: "モメンタムの整合性"
    confidence_threshold: 0.6
```

##### レンジ相場でのシナリオ
```yaml
ranging_market:
  range_boundary:
    name: "レンジ上限/下限への到達"
    conditions:
      - near_resistance: "過去に何度も意識された明確なレジスタンスラインに到達"
      - near_support: "過去に何度も意識された明確なサポートラインに到達"
      - reversal_indicators: "反転を示すオシレーター"
    confidence_threshold: 0.6
```

### 3.3 GATE 3: トリガーゲート

#### 3.3.1 目的
最終的なエントリー実行のGOサインを出すフィルター

#### 3.3.2 使用時間足
- **主要**: 5m（5分足）
- **補助**: 1m（1分足）

#### 3.3.3 検出パターン

##### パターン1: プライスアクションによる反転確認
```yaml
name: "price_action_reversal"
description: "ローソク足の形状から、短期的な力の反転を直接的に確認"

pinbar_pattern:
  bullish_pinbar:
    conditions:
      - long_lower_shadow: "下ヒゲが実体の2倍以上"
      - small_upper_shadow: "上ヒゲが実体の0.5倍以下"
      - near_support: "サポートゾーン付近での形成"
    confidence_threshold: 0.7
  
  bearish_pinbar:
    conditions:
      - long_upper_shadow: "上ヒゲが実体の2倍以上"
      - small_lower_shadow: "下ヒゲが実体の0.5倍以下"
      - near_resistance: "レジスタンスゾーン付近での形成"
    confidence_threshold: 0.7

engulfing_pattern:
  bullish_engulfing:
    conditions:
      - current_bullish: "現在のローソク足が陽線"
      - previous_bearish: "前のローソク足が陰線"
      - engulfs_previous: "現在の足が前の足を包み込む"
      - volume_confirmation: "ボリュームでの確認"
    confidence_threshold: 0.6
  
  bearish_engulfing:
    conditions:
      - current_bearish: "現在のローソク足が陰線"
      - previous_bullish: "前のローソク足が陽線"
      - engulfs_previous: "現在の足が前の足を包み込む"
      - volume_confirmation: "ボリュームでの確認"
    confidence_threshold: 0.6
```

##### パターン2: 出来高を伴う初動ブレイク
```yaml
name: "volume_breakout"
description: "出来高の急増を伴うことで、ブレイクアウトの信頼性を担保"

conditions:
  - high_volume: "M5.Volume_Ratio > 2.0"
  - price_breakout: "M5.priceが終値でレジスタンス/サポートを上抜け/下抜け"
  - momentum_confirmation: "MACDでのモメンタム確認"
confidence_threshold: 0.7
```

---

## 4. 設定ファイル仕様

### 4.1 ファイル構成
```
/app/modules/llm_analysis/config/
├── gate1_environment_patterns.yaml
├── gate2_scenario_patterns.yaml
├── gate3_trigger_patterns.yaml
└── three_gate_common.yaml
```

### 4.2 設定ファイル構造
```yaml
# 基本構造
patterns:
  pattern_name:
    name: "パターン名"
    description: "パターンの説明"
    conditions:
      - name: "条件名"
        indicator: "指標名"
        operator: "演算子"
        reference: "参照値"
        timeframe: "時間足"
        weight: 0.3
    confidence_calculation:
      method: "weighted_average"
      min_confidence: 0.7
    additional_data:
      # 追加データの定義
```

### 4.3 演算子一覧
- **比較演算子**: `>`, `<`, `>=`, `<=`, `==`, `!=`
- **範囲演算子**: `between`, `not_between`
- **論理演算子**: `all_above`, `all_below`, `any_above`, `any_below`
- **特殊演算子**: `near`, `engulfs`, `breaks`, `oscillates_around`

---

## 5. 実装仕様

### 5.1 クラス設計

#### 5.1.1 ThreeGateEngine
```python
class ThreeGateEngine:
    """三層ゲート式フィルタリングエンジン"""
    
    def __init__(self):
        self.pattern_loader = PatternLoader()
        self.technical_calculator = TechnicalCalculator()
        self.logger = logging.getLogger(__name__)
    
    async def evaluate(self, symbol: str, data: Dict) -> Optional[Dict]:
        """三層ゲートによる評価"""
        pass
    
    async def _evaluate_gate1(self, data: Dict) -> Dict:
        """GATE 1: 環境認識の評価"""
        pass
    
    async def _evaluate_gate2(self, data: Dict, gate1_result: Dict) -> Dict:
        """GATE 2: シナリオ選定の評価"""
        pass
    
    async def _evaluate_gate3(self, data: Dict, gate2_result: Dict) -> Dict:
        """GATE 3: トリガーの評価"""
        pass
```

#### 5.1.2 PatternLoader
```python
class PatternLoader:
    """パターン設定読み込みクラス"""
    
    def __init__(self, config_dir: str = "config"):
        self.config_dir = Path(__file__).parent.parent / config_dir
        self._patterns_cache = {}
    
    def load_gate_patterns(self, gate_number: int) -> Dict[str, Any]:
        """指定されたゲートのパターン設定を読み込み"""
        pass
    
    def reload_patterns(self, gate_number: int = None):
        """パターン設定の再読み込み"""
        pass
```

#### 5.1.3 ConditionEvaluator
```python
class ConditionEvaluator:
    """条件評価クラス"""
    
    async def evaluate_condition(self, indicators: Dict, condition: Dict) -> float:
        """個別条件の評価"""
        pass
    
    def _evaluate_comparison(self, value: float, operator: str, reference: Any) -> bool:
        """比較演算子の評価"""
        pass
    
    def _evaluate_range(self, value: float, operator: str, reference: List) -> bool:
        """範囲演算子の評価"""
        pass
```

### 5.2 データ構造

#### 5.2.1 ゲート結果構造
```python
@dataclass
class GateResult:
    valid: bool
    pattern: str
    confidence: float
    passed_conditions: List[str]
    failed_conditions: List[str]
    additional_data: Dict[str, Any]
    timestamp: datetime
```

#### 5.2.2 最終結果構造
```python
@dataclass
class ThreeGateResult:
    symbol: str
    gate1: GateResult
    gate2: GateResult
    gate3: GateResult
    overall_confidence: float
    signal_type: str
    entry_price: float
    stop_loss: float
    take_profit: List[float]
    timestamp: datetime
```

---

## 6. データフロー

### 6.1 処理フロー
```
1. データ取得
   ├── 1d足データ（GATE 1用）
   ├── 1h足データ（GATE 2用）
   └── 5m足データ（GATE 3用）

2. テクニカル指標計算
   ├── 既存のTechnicalCalculatorを使用
   └── 40個の指標を各時間足で計算

3. GATE 1評価
   ├── 環境認識パターンの検出
   ├── 信頼度スコアの計算
   └── 有効な環境の特定

4. GATE 2評価
   ├── GATE 1結果に基づくシナリオ選定
   ├── 環境連動条件の評価
   └── 有効なシナリオの特定

5. GATE 3評価
   ├── GATE 2結果に基づくトリガー確認
   ├── プライスアクション分析
   └── 最終シグナルの生成

6. 結果出力
   ├── シグナル生成
   ├── Discord通知
   └── データベース保存
```

### 6.2 エラーハンドリング
- 各ゲートでの失敗時の適切なログ出力
- 部分的な結果の保存
- システム全体の継続性確保

---

## 7. API仕様

### 7.1 メインAPI
```python
# 三層ゲート評価
result = await three_gate_engine.evaluate(symbol="USDJPY=X", data=market_data)

# パターン設定の再読み込み
pattern_loader.reload_patterns(gate_number=1)

# システム比較
comparison = await system_comparator.compare_systems()
```

### 7.2 設定API
```python
# パターン設定の取得
patterns = pattern_loader.load_gate_patterns(gate_number=1)

# 条件の取得
conditions = pattern_loader.get_pattern_conditions(1, "trending_market")

# 信頼度計算設定の取得
confidence_config = pattern_loader.get_confidence_calculation(1, "trending_market")
```

---

## 8. テスト仕様

### 8.1 単体テスト
- 各ゲートの独立テスト
- 条件評価ロジックのテスト
- パターン設定読み込みのテスト

### 8.2 統合テスト
- 三層ゲート全体のテスト
- 既存システムとの互換性テスト
- パフォーマンステスト

### 8.3 バックテスト
- 過去データでのパターン検出精度テスト
- 既存システムとの比較テスト
- シグナル生成率の改善確認

---

## 9. 運用仕様

### 9.1 監視項目
- 各ゲートの通過率
- パターン検出精度
- シグナル生成率
- システムパフォーマンス

### 9.2 ログ仕様
- 各ゲートの評価結果
- 条件の詳細評価
- エラーと例外の記録
- パフォーマンス指標

### 9.3 設定管理
- パターン設定のバージョン管理
- 設定変更の影響評価
- ロールバック手順

---

## 10. 実装計画

### 10.1 Phase 1: 基盤構築（1週間）
- [ ] プロジェクト構造の作成
- [ ] PatternLoaderの実装
- [ ] 基本設定ファイルの作成
- [ ] 単体テストの実装

### 10.2 Phase 2: GATE 1実装（1週間）
- [ ] GATE 1エンジンの実装
- [ ] 環境認識パターンの実装
- [ ] 設定ファイルの詳細化
- [ ] テストとデバッグ

### 10.3 Phase 3: GATE 2実装（1週間）
- [ ] GATE 2エンジンの実装
- [ ] シナリオ選定パターンの実装
- [ ] 環境連動ロジックの実装
- [ ] 統合テスト

### 10.4 Phase 4: GATE 3実装（1週間）
- [ ] GATE 3エンジンの実装
- [ ] トリガーパターンの実装
- [ ] プライスアクション分析の実装
- [ ] 最終統合テスト

### 10.5 Phase 5: システム統合（1週間）
- [ ] 新システム起動スクリプトの作成
- [ ] 監視ツールの実装
- [ ] 比較ツールの実装
- [ ] 運用テスト

### 10.6 Phase 6: 最適化（継続）
- [ ] パフォーマンス最適化
- [ ] パターン精度の改善
- [ ] 設定の調整
- [ ] 継続的改善

---

**文書管理情報**

- 文書ID: THREE-GATE-SYSTEM-SPEC-001
- バージョン: v1.0
- 作成日: 2025-09-18
- 最終更新: 2025-09-18
- 承認者: [システム設計者]
- 次回レビュー予定: 2025-10-18
