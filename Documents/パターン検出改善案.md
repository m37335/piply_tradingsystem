# 改善提案：三層ゲート式フィルタリングシステムの導入

**作成日**: 2025年9月18日
**最終更新**: 2025年9月19日
**提案者**: Gemini
**対象モジュール**: llm_analysis（ルールベース売買システム）
**バージョン**: v2.0

---

## 1. 概要

現在のパターン検出システムは、複数の条件を同時に評価し、総合スコアを算出する方式を採用している。しかし、シグナル生成率が0%であることから、ルールの厳格さ、および市場環境とのミスマッチが課題となっている。

本提案では、分析プロセスを**「①環境認識」「②シナリオ選定」「③トリガー」**という3つの連続した**ゲート（フィルター）**に分割する**「三層ゲート式フィルタリングシステム」**を導入する。これにより、各市場環境に最適化された取引シナリオのみを抽出し、シグナルの質と精度を飛躍的に向上させることを目的とする。

---

## 2. 三層ゲートの構造

### 🚪 GATE 1: 環境認識ゲート（マクロフィルター）

最上位のフィルターとして、「そもそも取引を検討すべき市場か？」を判断する。長期足（D1/H4）を用いて、大きな潮流を捉える。

#### 検出パターン

* **📈 パターン1: 確度の高いトレンド相場**
    * **目的**: 疑いのない、継続的な一方向の動きを特定する。
    * **条件 (買い)**:
        * `D1.price` > `D1.EMA_200`
        * **直近3本の日足終値**が、すべて`D1.EMA_200`を上回っている。
        * `D1.ADX` > **25**

* **🔄 パターン2: トレンド転換の初動**
    * **目的**: 大きな流れが反転する、高期待値の初期段階を捉える。
    * **条件 (買い転換)**:
        * 過去1ヶ月間、`D1.price`は主に`D1.EMA_200`の下で推移。
        * 直近で`D1.price`が`D1.EMA_200`を終値で明確に上抜けた。
        * `D1.MACD`がゴールデンクロス、またはヒストグラムがマイナス圏からプラス圏に転換。

* **횡 パターン3: 明確なレンジ相場**
    * **目的**: トレンドフォロー戦略を確実に除外すべき相場を定義する。
    * **条件**:
        * `D1.ADX` < **20** が5日間以上継続している。
        * `D1.price`が`D1.EMA_200`を何度もまたいでいる。

---

### 🎯 GATE 2: シナリオ選定ゲート（セットアップフィルター）

戦略の**心臓部**。GATE 1の判定結果に基づき、有効なシナリオのみを監視する。中期足（H1）を中心に分析する。

#### GATE 1の判定に応じた有効シナリオ

* **IF GATE 1 = 「トレンド相場」 THEN:**
    * **🌊 優位性の高い押し目/戻り**: `H1.price`が`H1.EMA_55`と`H1.EMA_21`の間のゾーンまで調整し、`H1.Stochastic_14`が過熱感のない領域にある状態。
    * **💥 ブレイクアウト準備完了**: `H1.Bollinger_Bands`の幅が過去100本で最小水準まで収縮している状態。

* **IF GATE 1 = 「トレンド転換」 THEN:**
    * **🔄 最初の押し目/戻り**: 転換後、初めて`H1.EMA_55`などの主要な移動平均線に引きつけてきた状態（リテスト）。

* **IF GATE 1 = 「レンジ相場」 THEN:**
    * **📉 レンジ上限/下限への到達**: `H1.price`が過去に何度も意識された明確なサポート/レジスタンスラインに到達した状態。

---

### ⏱️ GATE 3: トリガーゲート（タイミングフィルター）

最終的なエントリー実行のGOサインを出すフィルター。短期足（M5）を用いて、最もリスクが低く、期待値が高い瞬間を捉える。

#### 検出パターン

* **🕯️ パターン1: プライスアクションによる反転確認**
    * **目的**: ローソク足の形状から、短期的な力の反転を直接的に確認する。
    * **条件 (買い)**: GATE 2で特定したサポートゾーンで、`M5`のローソク足が明確な**ピンバー（下ヒゲが実体の2倍以上）**または**強気の包み足**を形成した。

* **🔊 パターン2: 出来高を伴う初動ブレイク**
    * **目的**: 出来高の急増を伴うことで、ブレイクアウトの信頼性を担保する。
    * **条件 (買い)**: GATE 2で特定したレジスタンスを`M5.price`が終値で上抜け、かつその足の`M5.Volume_Ratio`が **2.0** を超える。

---

## 3. 環境とシナリオの連動性

本システムの最大の強みは、GATE 1の環境認識とGATE 2のシナリオ選定が強く連動する点にある。

| GATE 1: 環境認識 | GATE 2で有効なシナリオ | GATE 2で無効なシナリオ |
| :--- | :--- | :--- |
| **確度の高いトレンド相場** | 押し目買い、ブレイクアウト | 逆張り系の全般 |
| **明確なレンジ相場** | レンジ上限/下限での反転 | トレンドフォロー系の全般 |
| **トレンド転換の初動** | 最初の押し目、ダイバージェンス | |

---

## 4. 期待される効果

1.  **ノイズの大幅な削減**: 長期足のフィルターにより、短期的なダマシや無駄なエントリーを未然に防ぐ。
2.  **勝率とリスクリワードの向上**: 3つの時間軸で優位性が確認された、質の高いセットアップにのみ取引を限定するため、期待値が向上する。
3.  **ロジックの明確化**: 「なぜエントリーするのか」という根拠が各ゲートの通過条件によって明確になり、後の分析や改善が容易になる。

**